<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retreat GSM GKPS - System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { touch-action: manipulation; }
        #reader { border: none !important; }
        #reader__scan_region img { display: none; }
        #reader__dashboard_section_csr button { 
            background-color: #4F46E5; color: white; border-radius: 8px; padding: 10px 20px; 
            border: none; font-weight: bold; margin-top: 10px; cursor: pointer; width: 100%;
        }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXYLTSAVZof9aFaeclHbeCdBX7tUNrhfA",
            authDomain: "reatreat-gsm-gkps-tangerang.firebaseapp.com",
            databaseURL: "https://reatreat-gsm-gkps-tangerang-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "reatreat-gsm-gkps-tangerang",
            storageBucket: "reatreat-gsm-gkps-tangerang.firebasestorage.app",
            messagingSenderId: "550180720678",
            appId: "1:550180720678:web:a95e50498477f29c2456e7",
            measurementId: "G-1MX72CSTBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbRemove = remove;
        window.dbUpdate = update;
        
        console.log("Sistem Cloud GKPS Siap!");
    </script>
</head>
<body class="bg-slate-50 text-slate-900 select-none">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useLayoutEffect, useRef } = React;

        const CloudAttendance = () => {
            // --- STATE UTAMA ---
            const [view, setViewRaw] = useState('login'); 
            const [currentUser, setCurrentUser] = useState(null); 
            const [users, setUsers] = useState([]); 
            const [sessions, setSessions] = useState([]); 
            const [selectedSession, setSelectedSession] = useState(null); 
            const [rundown, setRundown] = useState([]); 
            const [messages, setMessages] = useState([]); 
            
            const [participants, setParticipants] = useState([]);
            const [attendance, setAttendance] = useState([]); 
            const [isConnected, setIsConnected] = useState(false);
            
            // --- STATE UI ---
            const [scanResult, setScanResult] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [formData, setFormData] = useState({ nama: '', kategori: 'Anak Sekolah Minggu', kelas: '' });
            const [isDownloading, setIsDownloading] = useState(false);
            
            // --- STATE MANAJEMEN ---
            const [editingId, setEditingId] = useState(null);
            const [editingMessageId, setEditingMessageId] = useState(null);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'petugas', nama: '' });
            const [sessionForm, setSessionForm] = useState({ title: '', date: '', time: '' });
            const [rundownForm, setRundownForm] = useState({ date: '', time: '', activity: '' });
            const [selfPassword, setSelfPassword] = useState('');
            const [messageInput, setMessageInput] = useState(''); 

            const logoutTimerRef = useRef(null);
            const scannerRef = useRef(null);
            const classList = ["Daud", "Daniel", "Paulus", "Ester", "Pos PI Timotius", "Pos PI Abaraham", "PAGI", "UMUM"];

            // --- AUTO LOGOUT ---
            const resetLogoutTimer = () => {
                if (logoutTimerRef.current) clearTimeout(logoutTimerRef.current);
                if (currentUser) {
                    logoutTimerRef.current = setTimeout(() => handleLogout(true), 60000);
                }
            };

            useEffect(() => {
                const events = ['click', 'mousemove', 'keypress', 'scroll', 'touchstart'];
                const handleActivity = () => resetLogoutTimer();
                events.forEach(event => window.addEventListener(event, handleActivity));
                resetLogoutTimer();
                return () => {
                    events.forEach(event => window.removeEventListener(event, handleActivity));
                    if (logoutTimerRef.current) clearTimeout(logoutTimerRef.current);
                };
            }, [currentUser]);

            // --- NAVIGASI & SCROLL FIX ---
            useLayoutEffect(() => {
                if (!isDownloading) {
                    window.scrollTo({ top: 0, behavior: 'instant' });
                }
            }, [view]);

            // --- FUNGSI RESET & NAVIGASI (INTI PERBAIKAN) ---
            const setView = (newView) => {
                // Reset semua state form/edit saat pindah halaman
                setEditingId(null);
                setEditingMessageId(null);
                setShowAddForm(false); // Pastikan form input manual tertutup
                setNewUser({ username: '', password: '', role: 'petugas', nama: '' });
                setSessionForm({ title: '', date: '', time: '' });
                setRundownForm({ date: '', time: '', activity: '' });
                setFormData({ nama: '', kategori: 'Anak Sekolah Minggu', kelas: '' });
                setSelfPassword('');
                setMessageInput('');
                
                // Set halaman baru
                setViewRaw(newView);
            };

            const handleBackToMenu = () => {
                window.scrollTo({ top: 0, behavior: 'instant' });
                
                // Cek user login (Prioritas Memory -> Prioritas LocalStorage)
                const saved = localStorage.getItem('gkps_user');
                
                if (currentUser) {
                    setView('menu');
                } else if (saved) {
                    try {
                        // Restore session jika hilang karena refresh
                        const parsedUser = JSON.parse(saved);
                        setCurrentUser(parsedUser);
                        setView('menu');
                    } catch(e) {
                        setViewRaw('login');
                    }
                } else {
                    setViewRaw('login');
                }
            };

            // --- LOAD ICONS & DATA ---
            useEffect(() => {
                setTimeout(() => { try { lucide.createIcons(); } catch(e){} }, 300);
            }, [view, participants, users, sessions, rundown, messages]);

            useEffect(() => {
                const savedUser = localStorage.getItem('gkps_user');
                if (savedUser) {
                    try {
                        setCurrentUser(JSON.parse(savedUser));
                        setViewRaw('menu'); 
                    } catch(e) {}
                }

                const initSync = setTimeout(() => {
                    if (!window.db) return;
                    setIsConnected(true);

                    window.dbOnValue(window.dbRef(window.db, 'users'), (snapshot) => {
                        const data = snapshot.val();
                        if (!data) saveToCloud('users/admin', { username: 'admin', password: 'admin123', role: 'admin', nama: 'Super Admin' });
                        else setUsers(Object.values(data));
                    });

                    window.dbOnValue(window.dbRef(window.db, 'sessions'), (snapshot) => {
                        const data = snapshot.val();
                        setSessions(data ? Object.values(data).sort((a,b) => (a.date || '').localeCompare(b.date || '')) : []);
                    });

                    window.dbOnValue(window.dbRef(window.db, 'participants'), (snapshot) => {
                        const data = snapshot.val();
                        setParticipants(data ? Object.values(data) : []);
                    });

                    window.dbOnValue(window.dbRef(window.db, 'rundown'), (snapshot) => {
                        const data = snapshot.val();
                        setRundown(data ? Object.values(data).sort((a,b) => (a.time || '').localeCompare(b.time || '')) : []);
                    });

                    window.dbOnValue(window.dbRef(window.db, 'messages'), (snapshot) => {
                        const data = snapshot.val();
                        setMessages(data ? Object.values(data).reverse() : []);
                    });
                }, 1000);
                return () => clearTimeout(initSync);
            }, []);

            useEffect(() => {
                if (!selectedSession || !window.db) return;
                window.dbOnValue(window.dbRef(window.db, `attendance/${selectedSession}`), (snapshot) => {
                    const data = snapshot.val();
                    setAttendance(data ? Object.values(data) : []);
                });
            }, [selectedSession]);

            // --- CRUD HELPERS ---
            const saveToCloud = (path, data) => {
                if (!window.db) return alert("Belum terkoneksi database!");
                window.dbSet(window.dbRef(window.db, path), data).catch(err => alert("Gagal: " + err.message));
            };

            const deleteFromCloud = (path) => {
                if (!window.db) return;
                if(confirm("Yakin hapus data ini?")) window.dbRemove(window.dbRef(window.db, path));
            };

            const handleResetAllData = () => {
                if (prompt("Ketik 'HAPUS' untuk menghapus SEMUA Peserta & Absensi.") === 'HAPUS') {
                    window.dbRemove(window.dbRef(window.db, 'participants'));
                    window.dbRemove(window.dbRef(window.db, 'attendance'));
                    alert("DATABASE RESET.");
                }
            };

            // --- AUTH & USER ---
            const handleLogin = (e) => {
                e.preventDefault();
                const u = users.find(x => x.username === e.target.username.value && x.password === e.target.password.value);
                if (u) {
                    setCurrentUser(u);
                    localStorage.setItem('gkps_user', JSON.stringify(u)); 
                    setView('menu');
                } else alert("Login Gagal!");
            };

            const handleLogout = (force) => {
                if(force || confirm("Keluar?")) {
                    setCurrentUser(null);
                    localStorage.removeItem('gkps_user');
                    setView('login');
                }
            };

            const handleChangeSelfPassword = () => {
                if(selfPassword.length < 3) return alert("Min 3 karakter");
                const u = { ...currentUser, password: selfPassword };
                saveToCloud(`users/${currentUser.username}`, u);
                setCurrentUser(u);
                localStorage.setItem('gkps_user', JSON.stringify(u));
                alert("Sukses ubah password");
                handleBackToMenu();
            };

            // --- FUNGSI PESAN ---
            const handleSendMessage = () => {
                if(!messageInput) return;
                if (editingMessageId) {
                    const msg = messages.find(m => m.id === editingMessageId);
                    if(msg) saveToCloud(`messages/${editingMessageId}`, { ...msg, text: messageInput });
                    setEditingMessageId(null);
                } else {
                    const id = `MSG-${Date.now()}`;
                    saveToCloud(`messages/${id}`, {
                        id, text: messageInput, sender: currentUser.nama, senderUsername: currentUser.username, 
                        role: currentUser.role, timestamp: new Date().toLocaleString('id-ID')
                    });
                }
                setMessageInput('');
            };

            // --- MANAJEMEN ---
            const handleAddOrUpdateUser = () => {
                if(!newUser.username) return;
                saveToCloud(`users/${newUser.username}`, newUser);
                setNewUser({ username: '', password: '', role: 'petugas', nama: '' });
                setEditingId(null);
            };

            const handleAddOrUpdateSession = () => {
                if(!sessionForm.title) return;
                const id = editingId || `SESS-${Date.now()}`;
                const dateObj = new Date(sessionForm.date);
                const name = `${sessionForm.title}, ${dateObj.toLocaleDateString('id-ID', {day:'numeric',month:'short'})} ${sessionForm.time}`;
                saveToCloud(`sessions/${id}`, { id, name, ...sessionForm });
                setSessionForm({ title: '', date: '', time: '' });
                setEditingId(null);
            };

            const handleAddOrUpdateRundown = () => {
                if(!rundownForm.activity) return;
                const id = editingId || `RUN-${Date.now()}`;
                saveToCloud(`rundown/${id}`, { id, completed: false, ...rundownForm });
                setRundownForm({ date: '', time: '', activity: '' });
                setEditingId(null);
            };

            // --- MANAJEMEN PESERTA ---
            const handleAddOrUpdateParticipant = () => {
                if(!formData.nama) return;
                const id = editingId || `M-${Date.now()}`;
                saveToCloud(`participants/${id}`, { id, ...formData });
                setFormData({nama:'', kategori:'Anak Sekolah Minggu', kelas: ''});
                setEditingId(null);
                if(editingId) setShowAddForm(false);
            };

            // --- SCANNER ---
            useEffect(() => {
                if (view === 'scan' && !scanResult) {
                    setTimeout(() => {
                        if (scannerRef.current) scannerRef.current.clear().catch(()=>{});
                        const s = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
                        s.render((txt) => { handleScanSuccess(txt); s.clear(); }, () => {});
                        scannerRef.current = s;
                    }, 500);
                    return () => { if (scannerRef.current) scannerRef.current.clear().catch(()=>{}); };
                }
            }, [view, scanResult]);

            const handleScanSuccess = (qrId) => {
                if (!selectedSession) return setScanResult({ success: false, msg: 'Pilih Sesi Dulu!' });
                const p = participants.find(i => i.id === qrId);
                if (!p) return setScanResult({ success: false, msg: 'QR Tidak Terdaftar!' });
                if (attendance.find(i => i.id === qrId)) return setScanResult({ success: false, msg: 'Sudah Check-in', p });
                
                const att = { ...p, timestamp: new Date().toLocaleString('id-ID'), device: currentUser.username, sessionId: selectedSession };
                saveToCloud(`attendance/${selectedSession}/${p.id}`, att);
                setScanResult({ success: true, msg: 'Berhasil!', p, time: att.timestamp });
            };

            // --- FITUR DOWNLOAD ---
            const generateQRUrl = (id) => `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${id}`;

            const downloadSingleQR = async (e, p) => {
                e.preventDefault();
                e.stopPropagation();
                try {
                    const response = await fetch(generateQRUrl(p.id));
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `QR_${p.nama.replace(/[^a-zA-Z0-9]/g, '_')}.png`; 
                    link.style.display = 'none'; // Tambahan keamanan style
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error(error);
                    alert("Gagal mendownload gambar. Cek koneksi internet.");
                }
            };

            const downloadAllQR = async () => {
                if (participants.length === 0) return;
                setIsDownloading(true);
                alert("Proses download dimulai. Mohon tunggu dan JANGAN tutup browser.");
                
                for (const p of participants) {
                    try {
                        const res = await fetch(generateQRUrl(p.id));
                        const blob = await res.blob();
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `QR_${p.nama.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        await new Promise(r => setTimeout(r, 800)); 
                    } catch (e) { console.log("Skip error"); }
                }
                setIsDownloading(false);
                alert("Semua Download Selesai!");
            };

            const handleCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const lines = ev.target.result.split('\n');
                    let count = 0;
                    lines.forEach((line, idx) => {
                        if(idx === 0) return; 
                        const [nama, kategori, kelas] = line.split(',').map(s => s?.trim());
                        if (nama) {
                            const id = `GSM-${Date.now()}-${idx}`;
                            saveToCloud(`participants/${id}`, { id, nama, kategori: kategori || 'Umum', kelas: kelas || '-' });
                            count++;
                        }
                    });
                    alert(`Berhasil import ${count} data.`);
                };
                reader.readAsText(file);
            };

            // --- VIEW RENDERERS ---
            if (view === 'login') return (
                <div className="min-h-screen bg-indigo-900 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-sm">
                        <h1 className="text-2xl font-bold text-center mb-6 text-indigo-800">System Login</h1>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input name="username" className="w-full p-3 border rounded" placeholder="Username" required/>
                            <input type="password" name="password" className="w-full p-3 border rounded" placeholder="Password" required/>
                            <button className="w-full bg-indigo-600 text-white font-bold py-3 rounded">MASUK</button>
                        </form>
                        <p className="text-center text-xs mt-4 text-gray-400">{isConnected ? "Cloud Connected" : "Connecting..."}</p>
                    </div>
                </div>
            );

            // --- MAIN MENU ---
            const safeUser = currentUser || {};
            const isAdmin = safeUser.role === 'admin';
            const isPanitia = safeUser.role === 'panitia';

            if (view === 'menu') return (
                <div className="min-h-screen bg-indigo-50 p-4 pt-8">
                    <div className="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div className="bg-indigo-700 p-6 text-white flex justify-between">
                            <div><h1 className="text-xl font-bold">Halo, {safeUser.nama}</h1><p className="text-xs uppercase bg-indigo-800 px-2 py-1 rounded inline-block mt-1">{safeUser.role}</p></div>
                            <button onClick={() => handleLogout(false)} className="bg-indigo-800 p-2 rounded"><i data-lucide="log-out" width="16"></i></button>
                        </div>
                        <div className="p-6 space-y-3">
                            <button onClick={() => setView('manage_rundown')} className="w-full bg-cyan-50 p-4 rounded-xl flex items-center gap-3 border border-cyan-200"><i data-lucide="list-clock" className="text-cyan-600"></i> <span className="font-bold text-gray-700">Rundown</span></button>
                            <button onClick={() => setView('messages')} className="w-full bg-yellow-50 p-4 rounded-xl flex items-center gap-3 border border-yellow-200"><i data-lucide="message-circle" className="text-yellow-600"></i> <span className="font-bold text-gray-700">Pesan & Kesan</span></button>
                            {safeUser.role !== 'peserta' && (
                                <>
                                    {isAdmin && <button onClick={() => setView('manage_users')} className="w-full bg-blue-50 p-4 rounded-xl flex items-center gap-3 border border-blue-200"><i data-lucide="user-cog" className="text-blue-600"></i> <span className="font-bold text-gray-700">Atur User</span></button>}
                                    {isAdmin && <button onClick={() => setView('manage_sessions')} className="w-full bg-purple-50 p-4 rounded-xl flex items-center gap-3 border border-purple-200"><i data-lucide="calendar-clock" className="text-purple-600"></i> <span className="font-bold text-gray-700">Atur Sesi</span></button>}
                                    {isAdmin && <button onClick={() => setView('generate')} className="w-full bg-white border border-indigo-200 p-4 rounded-xl flex items-center gap-3"><i data-lucide="database" className="text-indigo-600"></i> <span className="font-bold text-gray-700">Database Peserta</span></button>}
                                    <button onClick={() => setView('scan')} className="w-full bg-indigo-600 text-white p-4 rounded-xl flex items-center gap-3 shadow-lg"><i data-lucide="camera"></i> <span className="font-bold">Mulai Scan</span></button>
                                    <button onClick={() => setView('report')} className="w-full bg-orange-50 p-4 rounded-xl flex items-center gap-3 border border-orange-200"><i data-lucide="file-spreadsheet" className="text-orange-600"></i> <span className="font-bold text-gray-700">Laporan</span></button>
                                </>
                            )}
                            <button onClick={() => setView('change_password')} className="w-full bg-slate-100 p-3 rounded text-slate-600 text-xs font-bold mt-2">Ganti Password</button>
                            {isAdmin && <button onClick={handleResetAllData} className="w-full text-red-500 text-xs mt-4">RESET DB</button>}
                        </div>
                    </div>
                </div>
            );

            if (view === 'change_password') return (
                <div className="p-4 bg-slate-100 min-h-screen"><div className="max-w-md mx-auto bg-white p-6 rounded shadow">
                    <button onClick={handleBackToMenu} className="mb-4 flex gap-2 text-sm"><i data-lucide="arrow-left"></i> Kembali</button>
                    <h2 className="font-bold mb-4">Ganti Password</h2>
                    <input type="password" placeholder="Password Baru" className="w-full border p-2 mb-2" onChange={e=>setSelfPassword(e.target.value)}/>
                    <button onClick={handleChangeSelfPassword} className="bg-blue-600 text-white p-2 rounded w-full">Simpan</button>
                </div></div>
            );

            if (view === 'messages') return (
                <div className="p-4 bg-slate-100 min-h-screen"><div className="max-w-md mx-auto">
                    <button onClick={handleBackToMenu} className="mb-4 flex gap-2 text-sm"><i data-lucide="arrow-left"></i> Kembali</button>
                    <div className="bg-white p-4 rounded shadow mb-4">
                        <textarea placeholder="Tulis pesan..." className="w-full border p-2 mb-2" value={messageInput} onChange={e=>setMessageInput(e.target.value)}></textarea>
                        <div className="flex gap-2"><button onClick={handleSendMessage} className="bg-yellow-500 text-white p-2 rounded flex-1">{editingMessageId ? 'Update' : 'Kirim'}</button>
                        {editingMessageId && <button onClick={()=>{setEditingMessageId(null); setMessageInput('')}} className="bg-gray-400 text-white p-2 rounded">Batal</button>}</div>
                    </div>
                    {messages.map(m => (
                        <div key={m.id} className="bg-white p-4 rounded shadow mb-2 border-l-4 border-yellow-400">
                            <p className="text-sm">"{m.text}"</p>
                            <div className="flex justify-between mt-2 text-xs text-gray-500"><span>{m.sender}</span><span>{m.timestamp}</span></div>
                            {(isAdmin || isPanitia || m.senderUsername===currentUser.username) && (
                                <div className="flex gap-2 justify-end mt-2">
                                    {m.senderUsername===currentUser.username && <button onClick={()=>{setMessageInput(m.text); setEditingMessageId(m.id)}} className="text-blue-500"><i data-lucide="pencil" width="14"></i></button>}
                                    <button onClick={()=>deleteFromCloud(`messages/${m.id}`)} className="text-red-500"><i data-lucide="trash-2" width="14"></i></button>
                                </div>
                            )}
                        </div>
                    ))}
                </div></div>
            );

            if (view === 'generate') return (
                <div className="min-h-screen bg-slate-100 p-4">
                    <div className="max-w-md mx-auto">
                        <button onClick={handleBackToMenu} className="mb-4 text-slate-600 flex items-center gap-2"><i data-lucide="arrow-left"></i> Kembali</button>
                        
                        <div className="bg-white rounded-xl shadow p-6">
                            <h2 className="font-bold text-xl mb-6 text-indigo-800 flex items-center gap-2"><i data-lucide="users"></i> Data Peserta</h2>
                            
                            <div className="mb-4 border-2 border-dashed p-4 text-center">
                                <input type="file" onChange={handleCSV} />
                                <p className="text-xs text-gray-400 mt-2">Format CSV: Nama,Kategori,Kelas</p>
                            </div>
                            
                            <button onClick={() => setShowAddForm(!showAddForm)} className="w-full text-indigo-600 font-bold mb-4">+ Input Manual</button>
                            {showAddForm && (
                                <div className="bg-gray-50 p-4 rounded mb-4">
                                    <input className="w-full p-2 border mb-2" placeholder="Nama" value={formData.nama} onChange={e=>setFormData({...formData, nama:e.target.value})}/>
                                    <select className="w-full p-2 border mb-2" value={formData.kategori} onChange={e=>setFormData({...formData, kategori:e.target.value})}>
                                        <option>Anak Sekolah Minggu</option><option>GSM</option><option>Panitia</option><option>Umum</option>
                                    </select>
                                    <select className="w-full p-2 border mb-2" value={formData.kelas} onChange={e=>setFormData({...formData, kelas:
