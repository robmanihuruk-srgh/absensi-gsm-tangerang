<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retreat GSM GKPS Tangerang</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @keyframes scan-line {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        .scan-animate {
            animation: scan-line 2s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const AttendanceSystem = () => {
            const [view, setView] = useState('menu');
            const [participants, setParticipants] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [scanning, setScanning] = useState(false);
            const [scanResult, setScanResult] = useState(null);
            
            // State Form
            const [showAddForm, setShowAddForm] = useState(false);
            const [formData, setFormData] = useState({ nama: '', kategori: 'Pemuda' });

            // State Loading Download
            const [isDownloading, setIsDownloading] = useState(false);

            const videoRef = useRef(null);
            const streamRef = useRef(null);
            const canvasRef = useRef(null);
            const scanIntervalRef = useRef(null);

            // Trigger Icons
            useEffect(() => {
                lucide.createIcons();
            }, [view, participants, scanResult]);

            // Load Data
            useEffect(() => {
                const savedParticipants = localStorage.getItem('retreat-participants');
                const savedAttendance = localStorage.getItem('retreat-attendance');
                if (savedParticipants) setParticipants(JSON.parse(savedParticipants));
                if (savedAttendance) setAttendance(JSON.parse(savedAttendance));
            }, []);

            const saveParticipants = (data) => {
                setParticipants(data);
                localStorage.setItem('retreat-participants', JSON.stringify(data));
            };

            const saveAttendance = (data) => {
                setAttendance(data);
                localStorage.setItem('retreat-attendance', JSON.stringify(data));
            };

            const resetData = () => {
                if (confirm('PERINGATAN: Yakin ingin menghapus SEMUA data?')) {
                    localStorage.clear();
                    setParticipants([]);
                    setAttendance([]);
                    alert('Data berhasil direset.');
                }
            };

            // PERBAIKAN 1: Menggunakan API QRServer (Lebih Stabil)
            const generateQRCode = (text) => {
                return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(text)}`;
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const lines = event.target.result.split('\n').filter(line => line.trim());
                    const newParticipants = lines.slice(1).map((line, index) => {
                        const parts = line.split(',');
                        const nama = parts[0]?.trim();
                        if (!nama) return null;
                        return {
                            id: `RETREAT-${Date.now()}-${index}`,
                            nama: nama,
                            kategori: parts[1]?.trim() || 'Umum'
                        };
                    }).filter(Boolean);

                    const combined = [...participants, ...newParticipants];
                    saveParticipants(combined);
                    alert(`${newParticipants.length} peserta berhasil dimuat!`);
                };
                reader.readAsText(file);
            };

            const handleManualAdd = () => {
                if (!formData.nama.trim()) return alert('Nama harus diisi!');
                const newP = { id: `RET-${Date.now()}`, nama: formData.nama, kategori: formData.kategori };
                saveParticipants([...participants, newP]);
                setFormData({ nama: '', kategori: 'Pemuda' });
                setShowAddForm(false);
                alert('Peserta ditambahkan');
            };

            const startScanning = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        streamRef.current = stream;
                        videoRef.current.onloadedmetadata = () => {
                            videoRef.current.play();
                            setScanning(true);
                            setScanResult(null);
                            scanIntervalRef.current = setInterval(scanQRCode, 500);
                        };
                    }
                } catch (err) {
                    alert('Gagal akses kamera. Pastikan HTTPS atau izin kamera aktif.');
                }
            };

            const stopScanning = () => {
                if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
                if (scanIntervalRef.current) clearInterval(scanIntervalRef.current);
                setScanning(false);
            };

            const scanQRCode = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                ctx.drawImage(videoRef.current, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) handleScanResult(code.data);
            };

            const handleScanResult = (qrData) => {
                stopScanning();
                const p = participants.find(x => x.id === qrData);
                
                if (!p) {
                    setScanResult({ success: false, message: 'QR Tidak Dikenali' });
                    return;
                }

                const exist = attendance.find(x => x.id === qrData);
                if (exist) {
                    setScanResult({ success: false, message: 'Sudah Check-in Sebelumnya', p, timestamp: exist.timestamp });
                    return;
                }

                const newAtt = { ...p, timestamp: new Date().toLocaleString('id-ID') };
                saveAttendance([...attendance, newAtt]);
                setScanResult({ success: true, message: 'Check-in Berhasil', p, timestamp: newAtt.timestamp });
            };

            const exportToCSV = () => {
                const headers = ['No,ID,Nama,Kategori,Waktu'];
                const rows = attendance.map((a, i) => `${i+1},${a.id},"${a.nama}",${a.kategori},"${a.timestamp}"`);
                const blob = new Blob([[headers, ...rows].join('\n')], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Laporan_Absensi_${new Date().toLocaleDateString('id-ID').replace(/\//g,'-')}.csv`;
                a.click();
            };

            // PERBAIKAN 2: Fungsi Download yang Mengambil Blob Image
            const downloadAllQR = async () => {
                if(participants.length === 0) return;
                setIsDownloading(true);
                alert('Mulai mendownload QR Code. Harap tunggu proses selesai...');

                for (const p of participants) {
                    try {
                        const url = generateQRCode(p.id);
                        
                        // Fetch gambar sebagai BLOB agar tidak diblokir browser
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);

                        const link = document.createElement('a');
                        link.href = blobUrl;
                        link.download = `QR_${p.nama.replace(/\s+/g, '_')}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Hapus memori blob
                        URL.revokeObjectURL(blobUrl);

                        // Delay sedikit agar browser tidak hang
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error('Gagal download:', p.nama);
                    }
                }
                
                setIsDownloading(false);
                alert('Semua download selesai!');
            };

            // --- VIEW: MENU ---
            if (view === 'menu') return (
                <div className="min-h-screen bg-blue-50 p-4 pt-10">
                    <div className="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6 text-center">
                        <h1 className="text-2xl font-bold text-indigo-800">Retreat GSM GKPS</h1>
                        <p className="text-gray-500 mb-6">Tangerang</p>
                        <div className="flex justify-center gap-4 mb-8">
                            <div className="bg-blue-100 p-2 rounded w-1/2">
                                <span className="block text-xs text-blue-600">Peserta</span>
                                <span className="text-xl font-bold text-blue-800">{participants.length}</span>
                            </div>
                            <div className="bg-green-100 p-2 rounded w-1/2">
                                <span className="block text-xs text-green-600">Hadir</span>
                                <span className="text-xl font-bold text-green-800">{attendance.length}</span>
                            </div>
                        </div>
                        <button onClick={() => setView('generate')} className="w-full bg-indigo-600 text-white p-4 rounded-xl mb-3 flex items-center justify-center gap-2 shadow hover:bg-indigo-700">
                            <i data-lucide="qr-code"></i> Database & QR
                        </button>
                        <button onClick={() => setView('scan')} className="w-full bg-green-600 text-white p-4 rounded-xl mb-3 flex items-center justify-center gap-2 shadow hover:bg-green-700">
                            <i data-lucide="camera"></i> Scan Kehadiran
                        </button>
                        <button onClick={() => setView('report')} className="w-full bg-white border border-gray-200 text-gray-700 p-4 rounded-xl flex items-center justify-center gap-2 shadow hover:bg-gray-50">
                            <i data-lucide="file-text"></i> Laporan
                        </button>
                        <button onClick={resetData} className="mt-6 text-xs text-red-400 flex items-center justify-center gap-1 mx-auto">
                            <i data-lucide="trash-2" width="12"></i> Reset Data
                        </button>
                    </div>
                </div>
            );

            // --- VIEW: GENERATE ---
            if (view === 'generate') return (
                <div className="min-h-screen bg-purple-50 p-4">
                    <div className="max-w-md mx-auto">
                        <button onClick={() => setView('menu')} className="mb-4 flex items-center gap-2 text-gray-600"><i data-lucide="arrow-left"></i> Kembali</button>
                        <div className="bg-white p-6 rounded-xl shadow">
                            <h2 className="text-xl font-bold text-purple-800 mb-4">Data Peserta</h2>
                            
                            <div className="mb-4 p-4 border-2 border-dashed rounded-lg text-center hover:bg-gray-50 transition">
                                <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" id="csv" />
                                <label htmlFor="csv" className="cursor-pointer text-purple-600 font-bold block">
                                    <i data-lucide="upload" className="mx-auto mb-1"></i> Upload CSV
                                </label>
                                <p className="text-xs text-gray-400">Format: Nama,Kategori</p>
                            </div>

                            <button onClick={() => setShowAddForm(!showAddForm)} className="text-sm text-purple-600 font-bold mb-3 block">+ Input Manual</button>
                            
                            {showAddForm && (
                                <div className="bg-gray-50 p-3 rounded mb-4 animate-fade-in">
                                    <input placeholder="Nama" className="w-full p-2 border rounded mb-2" value={formData.nama} onChange={e => setFormData({...formData, nama: e.target.value})} />
                                    <select className="w-full p-2 border rounded mb-2" value={formData.kategori} onChange={e => setFormData({...formData, kategori: e.target.value})}>
                                        <option>Anak Sekolah Minggu</option><option>GSM</option><option>Panitia</option><option>Umum</option>
                                    </select>
                                    <button onClick={handleManualAdd} className="w-full bg-purple-600 text-white py-2 rounded">Simpan</button>
                                </div>
                            )}

                            {participants.length > 0 && (
                                <button 
                                    onClick={downloadAllQR} 
                                    disabled={isDownloading}
                                    className={`w-full ${isDownloading ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'} text-white py-3 rounded-lg mb-6 font-bold flex items-center justify-center gap-2 transition`}
                                >
                                    {isDownloading ? (
                                        <span>Sedang mendownload...</span>
                                    ) : (
                                        <>
                                            <i data-lucide="download"></i> Download {participants.length} QR Code
                                        </>
                                    )}
                                </button>
                            )}

                            <div className="grid grid-cols-2 gap-3">
                                {participants.map(p => (
                                    <div key={p.id} className="border p-2 rounded text-center bg-gray-50">
                                        <img 
                                            src={generateQRCode(p.id)} 
                                            alt="QR" 
                                            className="w-full max-w-[150px] mx-auto mb-2 mix-blend-multiply" 
                                            loading="lazy"
                                        />
                                        <p className="font-bold text-xs truncate mt-1 text-gray-800">{p.nama}</p>
                                        <p className="text-[10px] text-gray-500">{p.kategori}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );

            // --- VIEW: SCAN ---
            if (view === 'scan') return (
                <div className="min-h-screen bg-black flex flex-col text-white">
                    <div className="p-4 flex justify-between items-center bg-gray-900 z-10">
                        <button onClick={() => { stopScanning(); setView('menu'); }} className="flex gap-2 items-center"><i data-lucide="arrow-left"></i> Menu</button>
                        <span className="font-bold">Scanner</span>
                        <div className="w-8"></div>
                    </div>
                    <div className="flex-1 relative flex items-center justify-center bg-black overflow-hidden">
                        {!scanning && !scanResult && (
                            <button onClick={startScanning} className="bg-green-600 px-8 py-3 rounded-full font-bold shadow-[0_0_15px_rgba(34,197,94,0.5)] flex items-center gap-2 hover:scale-105 transition">
                                <i data-lucide="camera"></i> MULAI SCAN
                            </button>
                        )}
                        <video ref={videoRef} className={`absolute w-full h-full object-cover ${scanning ? 'opacity-100' : 'opacity-0'}`} playsInline muted></video>
                        <canvas ref={canvasRef} className="hidden"></canvas>
                        
                        {scanning && (
                            <div className="absolute w-64 h-64 border-2 border-green-500 rounded-lg pointer-events-none">
                                <div className="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-green-500 -mt-1 -ml-1"></div>
                                <div className="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-green-500 -mt-1 -mr-1"></div>
                                <div className="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-green-500 -mb-1 -ml-1"></div>
                                <div className="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-green-500 -mb-1 -mr-1"></div>
                                <div className="absolute w-full h-0.5 bg-green-500 scan-animate shadow-[0_0_10px_lime]"></div>
                                <p className="absolute bottom-[-40px] w-full text-center text-sm bg-black/50 rounded px-2">Arahkan kamera ke QR</p>
                            </div>
                        )}

                        {scanResult && (
                            <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-6 z-50">
                                <div className="bg-white text-gray-800 p-6 rounded-2xl w-full max-w-sm text-center animate-bounce-in">
                                    <div className="flex justify-center mb-4">
                                        {scanResult.success ? 
                                            <i data-lucide="check-circle" className="text-green-500 w-16 h-16"></i> : 
                                            <i data-lucide="x-circle" className="text-red-500 w-16 h-16"></i>
                                        }
                                    </div>
                                    <h3 className={`text-2xl font-bold mb-2 ${scanResult.success ? 'text-green-700' : 'text-red-700'}`}>
                                        {scanResult.success ? 'BERHASIL' : 'GAGAL'}
                                    </h3>
                                    <p className="mb-4 font-medium text-gray-600">{scanResult.message}</p>
                                    
                                    {scanResult.p && (
                                        <div className="bg-gray-100 p-3 rounded-lg mb-4 border border-gray-200">
                                            <p className="text-xl font-bold text-gray-800">{scanResult.p.nama}</p>
                                            <p className="text-sm text-gray-500">{scanResult.p.kategori}</p>
                                            <p className="text-xs text-gray-400 mt-2 border-t pt-2">{scanResult.timestamp}</p>
                                        </div>
                                    )}
                                    <button onClick={() => { setScanResult(null); startScanning(); }} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                                        Scan Lagi
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            // --- VIEW: REPORT ---
            if (view === 'report') return (
                <div className="min-h-screen bg-orange-50 p-4">
                    <div className="max-w-md mx-auto bg-white rounded-xl shadow p-6">
                        <div className="flex justify-between items-center mb-6">
                            <button onClick={() => setView('menu')} className="text-gray-600"><i data-lucide="arrow-left"></i></button>
                            <h2 className="font-bold text-lg text-orange-600">Laporan Absensi</h2>
                            <button onClick={exportToCSV} className="text-green-600 flex items-center gap-1 font-bold text-sm bg-green-50 px-3 py-1 rounded hover:bg-green-100">
                                <i data-lucide="download" width="16"></i> CSV
                            </button>
                        </div>
                        <div className="overflow-x-auto rounded border">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 text-xs uppercase text-gray-600">
                                    <tr><th className="p-3">No</th><th className="p-3">Nama</th><th className="p-3">Waktu</th></tr>
                                </thead>
                                <tbody className="divide-y">
                                    {attendance.length === 0 ? (
                                        <tr><td colSpan="3" className="p-4 text-center text-gray-400">Belum ada data check-in.</td></tr>
                                    ) : attendance.map((a, i) => (
                                        <tr key={i} className="hover:bg-gray-50">
                                            <td className="p-3 text-gray-500">{i+1}</td>
                                            <td className="p-3 font-medium">
                                                {a.nama} <br/><span className="text-[10px] text-white bg-orange-400 px-1 rounded">{a.kategori}</span>
                                            </td>
                                            <td className="p-3 text-xs text-gray-500 font-mono">{a.timestamp.split(',')[1]}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AttendanceSystem />);
    </script>
</body>
</html>
