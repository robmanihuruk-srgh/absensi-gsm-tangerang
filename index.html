<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retreat GSM GKPS - Admin System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { touch-action: manipulation; }
        #reader { border: none !important; }
        #reader__scan_region img { display: none; }
        #reader__dashboard_section_csr button { 
            background-color: #4F46E5; color: white; border-radius: 8px; padding: 10px 20px; 
            border: none; font-weight: bold; margin-top: 10px; cursor: pointer; width: 100%;
        }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXYLTSAVZof9aFaeclHbeCdBX7tUNrhfA",
            authDomain: "reatreat-gsm-gkps-tangerang.firebaseapp.com",
            databaseURL: "https://reatreat-gsm-gkps-tangerang-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "reatreat-gsm-gkps-tangerang",
            storageBucket: "reatreat-gsm-gkps-tangerang.firebasestorage.app",
            messagingSenderId: "550180720678",
            appId: "1:550180720678:web:a95e50498477f29c2456e7",
            measurementId: "G-1MX72CSTBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbRemove = remove;
        window.dbUpdate = update;
        
        console.log("Sistem Cloud GKPS Siap!");
    </script>
</head>
<body class="bg-slate-50 text-slate-900 select-none">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CloudAttendance = () => {
            // --- STATE UTAMA ---
            const [view, setView] = useState('login'); 
            const [currentUser, setCurrentUser] = useState(null); 
            const [users, setUsers] = useState([]); 
            const [sessions, setSessions] = useState([]); 
            const [selectedSession, setSelectedSession] = useState(null); 
            
            const [participants, setParticipants] = useState([]);
            const [attendance, setAttendance] = useState([]); 
            const [isConnected, setIsConnected] = useState(false);
            
            // --- STATE UI ---
            const [scanResult, setScanResult] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [formData, setFormData] = useState({ nama: '', kategori: 'Anak Sekolah Minggu' });
            const [isDownloading, setIsDownloading] = useState(false);
            
            // --- STATE MANAJEMEN ---
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'petugas', nama: '' });
            const [newSessionName, setNewSessionName] = useState('');

            const scannerRef = useRef(null);

            // --- REALTIME SYNC ENGINE ---
            useEffect(() => {
                setTimeout(() => { try { lucide.createIcons(); } catch(e){} }, 100);
                
                const initSync = setTimeout(() => {
                    if (!window.db) return;
                    setIsConnected(true);

                    // 1. Load Users
                    const usersRef = window.dbRef(window.db, 'users');
                    window.dbOnValue(usersRef, (snapshot) => {
                        const data = snapshot.val();
                        if (!data) {
                            saveToCloud('users/admin', { username: 'admin', password: 'admin123', role: 'admin', nama: 'Super Admin' });
                        } else {
                            setUsers(Object.values(data));
                        }
                    });

                    // 2. Load Sessions
                    const sessRef = window.dbRef(window.db, 'sessions');
                    window.dbOnValue(sessRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const sortedSessions = Object.values(data).sort((a,b) => b.createdAt - a.createdAt);
                            setSessions(sortedSessions);
                            if (!selectedSession && sortedSessions.length > 0) {
                                setSelectedSession(sortedSessions[0].id);
                            }
                        } else {
                            setSessions([]);
                        }
                    });

                    // 3. Load Peserta
                    const pRef = window.dbRef(window.db, 'participants');
                    window.dbOnValue(pRef, (snapshot) => {
                        const data = snapshot.val();
                        setParticipants(data ? Object.values(data) : []);
                    });

                }, 1000);

                return () => clearTimeout(initSync);
            }, []);

            // 4. Load Kehadiran
            useEffect(() => {
                if (!selectedSession || !window.db) return;
                const attRef = window.dbRef(window.db, `attendance/${selectedSession}`);
                const unsub = window.dbOnValue(attRef, (snapshot) => {
                    const data = snapshot.val();
                    setAttendance(data ? Object.values(data) : []);
                });
                return () => unsub();
            }, [selectedSession]);

            // Refresh Icons
            useEffect(() => { 
                setTimeout(() => { try { lucide.createIcons(); } catch(e){} }, 50);
            }, [view, scanResult, participants, users, sessions]);

            // --- DATABASE ACTIONS ---
            const saveToCloud = (path, data) => {
                if (!window.db) return alert("Belum terkoneksi internet/database!");
                const ref = window.dbRef(window.db, path);
                window.dbSet(ref, data).catch(err => alert("Gagal Simpan: " + err.message));
            };

            const deleteFromCloud = (path) => {
                if (!window.db) return;
                if(confirm("Yakin ingin menghapus data ini?")) {
                    const ref = window.dbRef(window.db, path);
                    window.dbRemove(ref);
                }
            };

            // --- FITUR RESET DATABASE (ADMIN) ---
            const handleResetAllData = () => {
                const promptVal = prompt("PERINGATAN ADMIN!\n\nKetik 'HAPUS' untuk menghapus SEMUA Data Peserta & Absensi.\n(Data User & Sesi tidak akan dihapus)");
                if (promptVal === 'HAPUS') {
                    window.dbRemove(window.dbRef(window.db, 'participants'));
                    window.dbRemove(window.dbRef(window.db, 'attendance'));
                    alert("DATABASE BERHASIL DIRESET/DIKOSONGKAN.");
                } else {
                    alert("Dibatalkan.");
                }
            };

            // --- NAVIGATION HELPER (FIX BACK BUTTON) ---
            const handleBackToMenu = () => {
                // Pastikan user masih login sebelum kembali ke menu
                // Jika data user hilang (misal karena refresh), kembali ke login
                if (currentUser && currentUser.username) {
                    setView('menu');
                } else {
                    setView('login');
                }
            };

            // --- AUTHENTICATION ---
            const handleLogin = (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;

                const userFound = users.find(u => u.username === username && u.password === password);
                if (userFound) {
                    setCurrentUser(userFound);
                    setView('menu');
                } else {
                    alert("Username atau Password Salah!");
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setView('login');
            };

            const handleAddUser = () => {
                if(!newUser.username || !newUser.password) return alert("Lengkapi data user!");
                saveToCloud(`users/${newUser.username}`, newUser);
                setNewUser({ username: '', password: '', role: 'petugas', nama: '' });
                alert("User berhasil ditambahkan!");
            };

            const handleAddSession = () => {
                if(!newSessionName) return;
                const id = `SESS-${Date.now()}`;
                const sessData = { id, name: newSessionName, createdAt: Date.now() };
                saveToCloud(`sessions/${id}`, sessData);
                setNewSessionName('');
                alert("Sesi baru dibuat!");
            };

            // --- SCANNER LOGIC ---
            useEffect(() => {
                if (view === 'scan' && !scanResult) {
                    setTimeout(startScanner, 300);
                    return () => stopScanner(); 
                }
            }, [view, scanResult]);

            const startScanner = () => {
                if (scannerRef.current) scannerRef.current.clear().catch(()=>{});
                const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, aspectRatio: 1.0 }, false);
                scanner.render((decodedText) => {
                    handleScanSuccess(decodedText);
                    scanner.clear(); 
                }, (error) => {});
                scannerRef.current = scanner;
            };

            const stopScanner = () => {
                if (scannerRef.current) {
                    try { scannerRef.current.clear(); } catch(e){}
                    scannerRef.current = null;
                }
            };

            const handleScanSuccess = (qrId) => {
                if (!selectedSession) {
                    setScanResult({ success: false, msg: 'ERROR: Pilih Sesi Terlebih Dahulu!' });
                    return;
                }
                const p = participants.find(item => item.id === qrId);
                if (!p) {
                    setScanResult({ success: false, msg: 'QR Tidak Terdaftar di Database!' });
                    return;
                }
                const exist = attendance.find(item => item.id === qrId);
                if (exist) {
                    setScanResult({ success: false, msg: 'Sudah Check-in di Sesi Ini', p, time: exist.timestamp });
                    return;
                }
                const now = new Date();
                const newAtt = {
                    ...p,
                    timestamp: now.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }),
                    device: currentUser?.username || 'Unknown',
                    sessionId: selectedSession
                };
                saveToCloud(`attendance/${selectedSession}/${p.id}`, newAtt);
                setScanResult({ success: true, msg: 'Check-in Berhasil!', p, time: newAtt.timestamp });
            };

            // --- UTILITIES ---
            const generateQRUrl = (id) => `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${id}`;
            const getSessionName = (id) => sessions.find(s => s.id === id)?.name || 'Unknown Session';

            const downloadAllQR = async () => {
                if (participants.length === 0) return;
                setIsDownloading(true);
                alert("Mendownload QR Code... (Mohon Jangan Tutup Browser)");
                for (const p of participants) {
                    try {
                        const res = await fetch(generateQRUrl(p.id));
                        const blob = await res.blob();
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `QR_${p.nama.replace(/\s+/g, '_')}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        await new Promise(r => setTimeout(r, 500)); 
                    } catch (e) { console.error(e); }
                }
                setIsDownloading(false);
                alert("Selesai Download!");
            };

            const handleCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const lines = ev.target.result.split('\n').filter(l => l.trim());
                    let count = 0;
                    lines.slice(1).forEach((line, idx) => {
                        const [nama, kategori] = line.split(',').map(s => s?.trim());
                        if (nama) {
                            const id = `GSM-${Date.now()}-${idx}`;
                            saveToCloud(`participants/${id}`, { id, nama, kategori: kategori || 'Umum' });
                            count++;
                        }
                    });
                    alert(`Mengupload ${count} data ke Cloud...`);
                };
                reader.readAsText(file);
            };

            // --- VIEWS ---

            if (view === 'login') return (
                <div className="min-h-screen bg-indigo-900 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm animate-bounce-in">
                        <div className="text-center mb-6">
                            <h1 className="text-2xl font-bold text-indigo-800">System Login</h1>
                            <p className="text-gray-500 text-sm">Absensi Retreat GSM GKPS</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Username</label>
                                <input name="username" className="w-full p-3 border rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="admin" required/>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Password</label>
                                <input type="password" name="password" className="w-full p-3 border rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="***" required/>
                            </div>
                            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition shadow-lg">MASUK</button>
                        </form>
                        <div className="mt-4 text-center text-xs text-gray-400">
                            {isConnected ? <span className="text-green-500">● Cloud Connected</span> : <span className="text-red-500">● Connecting...</span>}
                        </div>
                    </div>
                </div>
            );

            // --- MENU UTAMA ---
            const safeUser = currentUser || { nama: 'Petugas', role: 'petugas' };
            const isAdmin = safeUser.role === 'admin';

            if (view === 'menu') return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 p-4 pt-8">
                    <div className="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div className="bg-indigo-700 p-6 text-white relative">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h1 className="text-xl font-bold">Halo, {safeUser.nama}</h1>
                                    <p className="opacity-80 text-xs uppercase tracking-wide bg-indigo-800 inline-block px-2 py-1 rounded mt-1">{safeUser.role}</p>
                                </div>
                                <button onClick={handleLogout} className="bg-indigo-800 hover:bg-red-500 p-2 rounded text-white text-xs transition"><i data-lucide="log-out" width="16"></i></button>
                            </div>
                        </div>

                        <div className="p-6 space-y-3">
                            {isAdmin && (
                                <>
                                    <div className="grid grid-cols-2 gap-3 mb-2">
                                        <button onClick={() => setView('manage_sessions')} className="bg-purple-100 hover:bg-purple-200 text-purple-800 p-3 rounded-xl text-sm font-bold flex flex-col items-center gap-1 border border-purple-200">
                                            <i data-lucide="calendar-clock"></i> Atur Sesi
                                        </button>
                                        <button onClick={() => setView('manage_users')} className="bg-blue-100 hover:bg-blue-200 text-blue-800 p-3 rounded-xl text-sm font-bold flex flex-col items-center gap-1 border border-blue-200">
                                            <i data-lucide="user-cog"></i> Atur User
                                        </button>
                                    </div>
                                    <button onClick={() => setView('generate')} className="w-full bg-white border border-gray-200 hover:border-indigo-500 p-4 rounded-xl flex items-center gap-3 shadow-sm group transition">
                                        <div className="bg-indigo-100 p-2 rounded text-indigo-600"><i data-lucide="database"></i></div>
                                        <div className="text-left"><h3 className="font-bold text-gray-700">Database Peserta</h3><p className="text-xs text-gray-500">Import CSV / Generate QR</p></div>
                                    </button>
                                    
                                    {/* TOMBOL RESET DATABASE (BARU) */}
                                    <button onClick={handleResetAllData} className="w-full bg-red-50 border border-red-200 hover:bg-red-100 p-3 rounded-xl flex items-center justify-center gap-2 mt-2 transition">
                                        <i data-lucide="alert-octagon" className="text-red-500" width="16"></i>
                                        <span className="text-red-600 font-bold text-xs">RESET DATABASE (HAPUS SEMUA)</span>
                                    </button>
                                </>
                            )}
                            
                            <button onClick={() => setView('scan')} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-xl flex items-center gap-3 shadow-lg transition transform active:scale-95">
                                <div className="bg-white/20 p-2 rounded"><i data-lucide="camera"></i></div>
                                <div className="text-left"><h3 className="font-bold">Mulai Scan Absensi</h3><p className="text-xs text-indigo-200">Mode Kamera</p></div>
                            </button>
                            
                            <button onClick={() => setView('report')} className="w-full bg-white border border-gray-200 hover:border-orange-500 p-4 rounded-xl flex items-center gap-3 shadow-sm group transition">
                                <div className="bg-orange-100 p-2 rounded text-orange-600"><i data-lucide="file-spreadsheet"></i></div>
                                <div className="text-left"><h3 className="font-bold text-gray-700">Laporan Kehadiran</h3><p className="text-xs text-gray-500">Lihat Data & Export</p></div>
                            </button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'manage_users') return (
                <div className="min-h-screen bg-slate-100 p-4">
                    <div className="max-w-md mx-auto">
                        <button onClick={handleBackToMenu} className="mb-4 text-slate-600 flex items-center gap-2"><i data-lucide="arrow-left"></i> Kembali</button>
                        <div className="bg-white rounded-xl shadow p-6 mb-4">
                            <h2 className="font-bold text-lg mb-4 flex gap-2 items-center"><i data-lucide="user-plus"></i> Tambah User</h2>
                            <div className="space-y-2">
                                <input placeholder="Username" className="w-full border p-2 rounded" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} />
                                <input placeholder="Password" className="w-full border p-2 rounded" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} />
                                <input placeholder="Nama Petugas" className="w-full border p-2 rounded" value={newUser.nama} onChange={e => setNewUser({...newUser, nama: e.target.value})} />
                                <select className="w-full border p-2 rounded" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})}>
                                    <option value="petugas">Petugas Scan</option>
                                    <option value="admin">Admin</option>
                                </select>
                                <button onClick={handleAddUser} className="w-full bg-blue-600 text-white p-2 rounded font-bold">Simpan User</button>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <h3 className="font-bold text-gray-600 ml-1">List User Terdaftar</h3>
                            {users.map(u => (
                                <div key={u.username} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
                                    <div>
                                        <p className="font-bold">{u.username}</p>
                                        <p className="text-xs text-gray-500">{u.nama} ({u.role})</p>
                                    </div>
                                    {u.username !== 'admin' && (
                                        <button onClick={() => deleteFromCloud(`users/${u.username}`)} className="text-red-500"><i data-lucide="trash-2"></i></button>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (view === 'manage_sessions') return (
                <div className="min-h-screen bg-slate-100 p-4">
                    <div className="max-w-md mx-auto">
                        <button onClick={handleBackToMenu} className="mb-4 text-slate-600 flex items-center gap-2"><i data-lucide="arrow-left"></i> Kembali</button>
                        <div className="bg-white rounded-xl shadow p-6 mb-4">
                            <h2 className="font-bold text-lg mb-4 flex gap-2 items-center"><i data-lucide="calendar-plus"></i> Buat Sesi Baru</h2>
                            <div className="flex gap-2">
                                <input placeholder="Nama Sesi (mis: Ibadah Pagi)" className="flex-1 border p-2 rounded" value={newSessionName} onChange={e => setNewSessionName(e.target.value)} />
                                <button onClick={handleAddSession} className="bg-purple-600 text-white p-2 rounded font-bold">Buat</button>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <h3 className="font-bold text-gray-600 ml-1">Daftar Sesi</h3>
                            {sessions.length === 0 && <p className="text-gray-400 text-center text-sm">Belum ada sesi dibuat.</p>}
                            {sessions.map(s => (
                                <div key={s.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-purple-500">
                                    <span className="font-bold text-slate-700">{s.name}</span>
                                    <button onClick={() => deleteFromCloud(`sessions/${s.id}`)} className="text-red-400 hover:text-red-600"><i data-lucide="trash-2"></i></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (view === 'generate') return (
                <div className="min-h-screen bg-slate-100 p-4">
                    <div className="max-w-md mx-auto">
                        {/* TOMBOL KEMBALI YANG SUDAH DIPERBAIKI */}
                        <button onClick={handleBackToMenu} className="mb-4 text-slate-600 flex items-center gap-2"><i data-lucide="arrow-left"></i> Kembali</button>
                        
                        <div className="bg-white rounded-xl shadow p-6">
                            <h2 className="font-bold text-xl mb-6 text-indigo-800 flex items-center gap-2"><i data-lucide="users"></i> Data Peserta</h2>
                            
                            <div className="mb-6 space-y-4">
                                <div className="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center relative hover:bg-slate-50 transition">
                                    <input type="file" accept=".csv" onChange={handleCSV} className="absolute inset-0 opacity-0 cursor-pointer" />
                                    <i data-lucide="upload-cloud" className="mx-auto text-indigo-400 w-8 h-8 mb-2"></i>
                                    <span className="text-sm font-bold text-indigo-600 block">Upload CSV ke Cloud</span>
                                    <span className="text-xs text-gray-400">Format: Nama,Kategori</span>
                                </div>
                                <button onClick={() => setShowAddForm(!showAddForm)} className="w-full text-sm font-bold text-indigo-600 hover:bg-indigo-50 py-2 rounded transition">+ Input Manual</button>
                                {showAddForm && (
                                    <div className="bg-slate-50 p-4 rounded border animate-bounce-in">
                                        <input className="w-full p-2 border rounded mb-2" placeholder="Nama Lengkap" value={formData.nama} onChange={e => setFormData({...formData, nama: e.target.value})} />
                                        <select className="w-full p-2 border rounded mb-2" value={formData.kategori} onChange={e => setFormData({...formData, kategori: e.target.value})}>
                                            <option>Anak Sekolah Minggu</option><option>GSM</option><option>Panitia</option><option>Umum</option>
                                        </select>
                                        <button onClick={() => {
                                            if(!formData.nama) return;
                                            const id = `M-${Date.now()}`;
                                            saveToCloud(`participants/${id}`, {id, nama: formData.nama, kategori: formData.kategori});
                                            setFormData({nama:'', kategori:'Anak Sekolah Minggu'});
                                            alert("Tersimpan ke Cloud!");
                                        }} className="bg-indigo-600 text-white px-3 py-2 rounded w-full font-bold">Simpan</button>
                                    </div>
                                )}
                            </div>

                            {participants.length > 0 && (
                                <button onClick={downloadAllQR} disabled={isDownloading} className="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold mb-6 flex justify-center gap-2 transition">
                                    {isDownloading ? 'Sedang Download...' : <><i data-lucide="download"></i> Download Semua QR</>}
                                </button>
                            )}

                            <div className="grid grid-cols-2 gap-3">
                                {participants.map(p => (
                                    <div key={p.id} className="border p-3 rounded text-center bg-white shadow-sm hover:shadow-md transition">
                                        <img src={generateQRUrl(p.id)} className="w-24 mx-auto mb-2 mix-blend-multiply" loading="lazy"/>
                                        <p className="font-bold text-xs truncate text-slate-800">{p.nama}</p>
                                        <p className="text-[10px] text-gray-500 bg-gray-100 rounded px-1 inline-block mt-1">{p.kategori}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (view === 'scan') return (
                <div className="min-h-screen bg-black flex flex-col">
                    <div className="p-4 bg-gray-900 text-white flex justify-between items-center z-10 shadow-lg">
                        <button onClick={handleBackToMenu} className="flex items-center gap-2 text-gray-300 hover:text-white"><i data-lucide="arrow-left"></i> Menu</button>
                        <span className="font-bold tracking-widest text-indigo-400">SCANNER</span>
                        <div className="w-16"></div>
                    </div>
                    <div className="bg-gray-800 p-2 flex justify-center">
                        <select className="bg-gray-700 text-white text-sm p-2 rounded border border-gray-600 max-w-xs" 
                                value={selectedSession || ''} 
                                onChange={(e) => setSelectedSession(e.target.value)}>
                            <option value="" disabled>-- Pilih Sesi Kegiatan --</option>
                            {sessions.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                    </div>
                    <div className="flex-1 bg-black relative flex flex-col justify-center items-center">
                        <div className="w-full max-w-sm px-4">
                            {!selectedSession ? (
                                <div className="text-center text-gray-400 p-8 border border-gray-700 rounded-xl">
                                    <i data-lucide="alert-triangle" className="mx-auto mb-2 text-yellow-500"></i>
                                    <p>Mohon Pilih Sesi Kegiatan di atas untuk mulai scan.</p>
                                </div>
                            ) : (
                                !scanResult && <div id="reader" className="w-full bg-black rounded-xl overflow-hidden border-2 border-indigo-600 shadow-[0_0_20px_rgba(79,70,229,0.5)]"></div>
                            )}
                        </div>
                        {scanResult && (
                            <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-6 backdrop-blur-sm">
                                <div className="bg-white w-full max-w-sm rounded-2xl p-6 text-center animate-bounce-in shadow-2xl">
                                    <div className="flex justify-center mb-4">
                                        {scanResult.success ? <i data-lucide="check-circle" className="text-emerald-500 w-20 h-20"></i> : <i data-lucide="x-circle" className="text-red-500 w-20 h-20"></i>}
                                    </div>
                                    <h3 className={`text-2xl font-black mb-2 ${scanResult.success ? 'text-emerald-700' : 'text-red-600'}`}>{scanResult.success ? 'BERHASIL' : 'GAGAL'}</h3>
                                    <p className="text-gray-600 font-medium mb-4">{scanResult.msg}</p>
                                    
                                    {scanResult.p && (
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 shadow-inner">
                                            <h4 className="text-xl font-bold text-slate-800">{scanResult.p.nama}</h4>
                                            <span className="inline-block bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full mt-1 mb-2">{scanResult.p.kategori}</span>
                                            <p className="text-xs text-slate-400 border-t border-slate-200 pt-2">{scanResult.time}</p>
                                        </div>
                                    )}
                                    <button onClick={() => { setScanResult(null); }} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">Scan Lagi</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            if (view === 'report') return (
                <div className="min-h-screen bg-orange-50 p-4">
                    <div className="max-w-md mx-auto">
                        <button onClick={handleBackToMenu} className="mb-4 text-slate-600 flex items-center gap-2"><i data-lucide="arrow-left"></i> Kembali</button>
                        <div className="bg-white rounded-xl shadow overflow-hidden">
                            <div className="p-4 border-b bg-orange-50">
                                <h2 className="font-bold text-orange-800 flex items-center gap-2 mb-3"><i data-lucide="clipboard-list"></i> Laporan Realtime</h2>
                                <div className="flex gap-2 mb-2">
                                    <select className="flex-1 text-sm border p-2 rounded bg-white" value={selectedSession || ''} onChange={(e) => setSelectedSession(e.target.value)}>
                                        <option value="" disabled>-- Pilih Sesi --</option>
                                        {sessions.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                    </select>
                                </div>
                                {selectedSession && (
                                    <button onClick={() => {
                                        const sessionName = getSessionName(selectedSession);
                                        const csv = ['No,ID,Nama,Kategori,Waktu,Petugas', ...attendance.map((a,i) => `${i+1},${a.id},"${a.nama}",${a.kategori},"${a.timestamp}",${a.device||'-'}`)].join('\n');
                                        const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'})); link.download = `Absensi_${sessionName}.csv`; link.click();
                                    }} className="w-full bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-2 rounded-lg font-bold flex justify-center gap-1 items-center transition shadow-sm"><i data-lucide="download" width="14"></i> EXPORT CSV SESI INI</button>
                                )}
                            </div>
                            <div className="overflow-x-auto min-h-[300px]">
                                {!selectedSession ? (
                                    <p className="text-center text-gray-400 py-10">Pilih sesi untuk melihat data.</p>
                                ) : attendance.length === 0 ? (
                                    <p className="text-center text-gray-400 py-10">Belum ada data hadir di sesi ini.</p>
                                ) : (
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 text-gray-500 font-medium text-xs uppercase"><tr><th className="p-3">No</th><th className="p-3">Nama</th><th className="p-3">Waktu</th></tr></thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {attendance.map((a, i) => (
                                                <tr key={i} className="hover:bg-orange-50/50 transition">
                                                    <td className="p-3 text-gray-400 font-mono">{i+1}</td>
                                                    <td className="p-3"><span className="font-bold text-gray-700 block">{a.nama}</span><span className="text-[10px] text-orange-500 bg-orange-100 px-1 rounded">{a.kategori}</span></td>
                                                    <td className="p-3 text-xs text-gray-500">{a.timestamp} <br/><span className="text-[9px] text-gray-400">by {a.device}</span></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );

            // --- JARING PENGAMAN (SAFETY NET) ---
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 text-center p-4">
                    <div>
                        <h1 className="text-2xl font-bold text-gray-400 mb-2">Memuat...</h1>
                        <p className="text-sm text-gray-400 mb-4">Jika halaman tidak muncul, klik tombol di bawah.</p>
                        <button onClick={() => window.location.reload()} className="bg-indigo-600 text-white px-4 py-2 rounded">Refresh Halaman</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CloudAttendance />);
    </script>
</body>
</html>
