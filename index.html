<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retreat GSM GKPS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFF5F7">
    <meta name="application-name" content="Retreat GSM">
    <meta name="apple-mobile-web-app-title" content="Retreat GSM">
    
    <!-- Ikon Aplikasi -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/480/church.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/church.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Font Tambahan -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { 
            touch-action: manipulation; 
            font-family: 'Nunito', sans-serif;
            background-color: #FFF5F7; 
            overscroll-behavior-y: none;
        }
        h1, h2, h3, h4 {
            font-family: 'Fredoka', sans-serif;
        }

        #reader { border: none !important; border-radius: 20px; overflow: hidden; }
        #reader__scan_region img { display: none; }
        #reader__dashboard_section_csr button { 
            background-color: #FF6B6B; color: white; border-radius: 12px; padding: 12px 20px; 
            border: none; font-weight: bold; margin-top: 15px; cursor: pointer; width: 100%;
            box-shadow: 0 4px 0 #D64545; 
            transition: all 0.2s;
        }
        #reader__dashboard_section_csr button:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .animate-bounce-in { animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .barcode-card {
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
            border: 4px solid rgba(255,255,255,0.4);
        }
        
        .bg-school-sunday {
             background: radial-gradient(circle at 10% 20%, rgb(255, 246, 200) 0%, rgb(255, 255, 255) 90%);
             background-attachment: fixed;
        }

        .btn-playful {
            transition: all 0.2s;
            border-bottom-width: 4px;
        }
        .btn-playful:active {
            transform: translateY(4px);
            border-bottom-width: 0px;
            margin-bottom: 4px; 
        }
        .btn-blue { @apply bg-sky-400 border-sky-600 text-white hover:bg-sky-500; }
        .btn-yellow { @apply bg-yellow-400 border-yellow-600 text-yellow-900 hover:bg-yellow-500; }
        .btn-green { @apply bg-emerald-400 border-emerald-600 text-white hover:bg-emerald-500; }
        .btn-purple { @apply bg-violet-400 border-violet-600 text-white hover:bg-violet-500; }
        .btn-red { @apply bg-rose-400 border-rose-600 text-white hover:bg-rose-500; }
        .btn-orange { @apply bg-orange-400 border-orange-600 text-white hover:bg-orange-500; }
        .btn-white { @apply bg-white border-slate-200 text-slate-700 hover:bg-slate-50; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(-5deg); }
            75% { transform: translateX(-50%) rotate(5deg); }
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Timeline styling Updated V3 (Fixed Layout) */
        .timeline-container {
            position: relative;
            padding-left: 20px;
        }
        /* Garis timeline diposisikan di 80px dari kiri (titik tengah dot) */
        .timeline-line-colorful {
            position: absolute;
            left: 80px; 
            top: 20px;
            bottom: 0;
            width: 4px;
            /* Pola garis putus-putus warna-warni */
            background: repeating-linear-gradient(
                to bottom,
                #FF9A9E,
                #FF9A9E 12px,
                transparent 12px,
                transparent 20px,
                #a5b4fc 20px,
                #a5b4fc 32px,
                transparent 32px,
                transparent 40px
            );
            z-index: 0;
            border-radius: 99px;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXYLTSAVZof9aFaeclHbeCdBX7tUNrhfA",
            authDomain: "reatreat-gsm-gkps-tangerang.firebaseapp.com",
            databaseURL: "https://reatreat-gsm-gkps-tangerang-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "reatreat-gsm-gkps-tangerang",
            storageBucket: "reatreat-gsm-gkps-tangerang.firebasestorage.app",
            messagingSenderId: "550180720678",
            appId: "1:550180720678:web:a95e50498477f29c2456e7",
            measurementId: "G-1MX72CSTBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbRemove = remove;
        window.dbUpdate = update;
        
        console.log("Sistem Cloud GKPS Siap!");
    </script>
</head>
<body class="bg-school-sunday text-slate-800 select-none min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useLayoutEffect, useRef } = React;

        const CloudAttendance = () => {
            const [view, setViewRaw] = useState('login'); 
            const [currentUser, setCurrentUser] = useState(null); 
            const [users, setUsers] = useState([]); 
            const [sessions, setSessions] = useState([]); 
            const [selectedSession, setSelectedSession] = useState(null); 
            const [rundown, setRundown] = useState([]); 
            const [messages, setMessages] = useState([]); 
            
            const [participants, setParticipants] = useState([]);
            const [attendance, setAttendance] = useState([]); 
            const [isConnected, setIsConnected] = useState(false);
            
            const [scanResult, setScanResult] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [formData, setFormData] = useState({ nama: '', kategori: 'Anak Sekolah Minggu', kelas: '' });
            const [isDownloading, setIsDownloading] = useState(false);
            
            // --- STATE MODALS ---
            const [isLogoutModalOpen, setIsLogoutModalOpen] = useState(false); 
            const [isInstallModalOpen, setIsInstallModalOpen] = useState(false); 
            const [deleteConfig, setDeleteConfig] = useState({ show: false, path: null });
            
            // --- STATE ADMIN RESET ---
            const [adminResetConfig, setAdminResetConfig] = useState({ show: false, user: null, newPass: '' });
            
            const [notification, setNotification] = useState(null); 
            
            const [editingId, setEditingId] = useState(null);
            const [editingMessageId, setEditingMessageId] = useState(null); 
            
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'petugas', nama: '' });
            const [sessionForm, setSessionForm] = useState({ title: '', date: '', time: '' });
            const [rundownForm, setRundownForm] = useState({ date: '', time: '', activity: '' });
            const [selfPassword, setSelfPassword] = useState('');
            const [messageInput, setMessageInput] = useState(''); 
            
            // --- STATE RESET PASSWORD LOGIN SCREEN ---
            const [resetForm, setResetForm] = useState({ username: '', newPassword: '', token: '' });

            const classList = ["Daud", "Daniel", "Paulus", "Ester", "Pos PI Timotius", "Pos PI Abaraham", "PAGI", "UMUM"];
            const scannerRef = useRef(null);
            
            // --- PALET WARNA UNTUK JADWAL ---
            const rundownColors = [
                { bg: 'bg-orange-100', border: 'border-orange-200', text: 'text-orange-800', icon: 'bg-orange-400' },
                { bg: 'bg-sky-100', border: 'border-sky-200', text: 'text-sky-800', icon: 'bg-sky-400' },
                { bg: 'bg-rose-100', border: 'border-rose-200', text: 'text-rose-800', icon: 'bg-rose-400' },
                { bg: 'bg-emerald-100', border: 'border-emerald-200', text: 'text-emerald-800', icon: 'bg-emerald-400' },
                { bg: 'bg-violet-100', border: 'border-violet-200', text: 'text-violet-800', icon: 'bg-violet-400' }
            ];

            const playFunnySound = () => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    const ctx = new AudioContext();
                    const t = ctx.currentTime;
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(200, t);
                    osc.frequency.exponentialRampToValueAtTime(600, t + 0.1);
                    osc.frequency.exponentialRampToValueAtTime(150, t + 0.3);
                    gain.gain.setValueAtTime(0.3, t);
                    gain.gain.linearRampToValueAtTime(0, t + 0.3);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(t);
                    osc.stop(t + 0.3);
                } catch(e) { console.log("Audio play error", e); }
            };

            const playErrorSound = () => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    const ctx = new AudioContext();
                    const t = ctx.currentTime;
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, t);
                    osc.frequency.linearRampToValueAtTime(100, t + 0.3);
                    gain.gain.setValueAtTime(0.3, t);
                    gain.gain.linearRampToValueAtTime(0, t + 0.3);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(t);
                    osc.stop(t + 0.3);
                } catch(e) { console.log("Audio play error", e); }
            };

            // --- AUTO NOTIFICATION REMOVED ---

            useLayoutEffect(() => {
                window.scrollTo({ top: 0, behavior: 'instant' });
            }, [view]);

            const setView = (newView) => {
                setEditingId(null);
                setEditingMessageId(null);
                setNewUser({ username: '', password: '', role: 'petugas', nama: '' });
                setSessionForm({ title: '', date: '', time: '' });
                setRundownForm({ date: '', time: '', activity: '' });
                setFormData({ nama: '', kategori: 'Anak Sekolah Minggu', kelas: '' });
                setSelfPassword('');
                setMessageInput('');
                setResetForm({ username: '', newPassword: '', token: '' }); // Reset form lupa password
                setIsLogoutModalOpen(false); 
                setIsInstallModalOpen(false);
                setDeleteConfig({ show: false, path: null });
                setAdminResetConfig({ show: false, user: null, newPass: '' });
                setViewRaw(newView);
            };

            const handleBackToMenu = () => {
                window.scrollTo({ top: 0, behavior: 'instant' });
                if (currentUser) {
                    setViewRaw('menu');
                } else {
                    const saved = localStorage.getItem('gkps_user');
                    if (saved) {
                        try {
                            setCurrentUser(JSON.parse(saved));
                            setViewRaw('menu');
                        } catch(e) { setViewRaw('login'); }
                    } else {
                        setViewRaw('login');
                    }
                }
            };

            // --- REALTIME SYNC ENGINE ---
            useEffect(() => {
                const savedUser = localStorage.getItem('gkps_user');
                if (savedUser) {
                    try {
                        setCurrentUser(JSON.parse(savedUser));
                        setViewRaw('menu'); 
                    } catch(e) {}
                }
                setTimeout(() => { try { lucide.createIcons(); } catch(e){} }, 100);
                const initSync = setTimeout(() => {
                    if (!window.db) return;
                    setIsConnected(true);
                    window.dbOnValue(window.dbRef(window.db, 'users'), (snapshot) => {
                        const data = snapshot.val();
                        if (!data) { saveToCloud('users/admin', { username: 'admin', password: 'admin123', role: 'admin', nama: 'Super Admin' }); } 
                        else { setUsers(Object.values(data)); }
                    });
                    window.dbOnValue(window.dbRef(window.db, 'sessions'), (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const arr = Object.values(data);
                            const sortedSessions = arr.sort((a,b) => {
                                const dateA = a.date || ''; const dateB = b.date || '';
                                if (dateA !== dateB) return dateA.localeCompare(dateB);
                                return (a.time || '').localeCompare(b.time || '');
                            });
                            setSessions(sortedSessions);
                            if (!selectedSession && sortedSessions.length > 0) setSelectedSession(sortedSessions[0].id);
                        } else { setSessions([]); }
                    });
                    window.dbOnValue(window.dbRef(window.db, 'participants'), (snapshot) => {
                        const data = snapshot.val(); setParticipants(data ? Object.values(data) : []);
                    });
                    window.dbOnValue(window.dbRef(window.db, 'rundown'), (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const arr = Object.values(data);
                            const sortedRundown = arr.sort((a,b) => {
                                const dateA = a.date || ''; const dateB = b.date || '';
                                if (dateA !== dateB) return dateA.localeCompare(dateB);
                                return (a.time || '').localeCompare(b.time || '');
                            });
                            setRundown(sortedRundown);
                        } else { setRundown([]); }
                    });
                    window.dbOnValue(window.dbRef(window.db, 'messages'), (snapshot) => {
                        const data = snapshot.val(); setMessages(data ? Object.values(data).reverse() : []);
                    });
                }, 1000);
                return () => clearTimeout(initSync);
            }, []);

            useEffect(() => {
                if (!selectedSession || !window.db) return;
                const unsub = window.dbOnValue(window.dbRef(window.db, `attendance/${selectedSession}`), (snapshot) => {
                    const data = snapshot.val(); setAttendance(data ? Object.values(data) : []);
                });
                return () => unsub();
            }, [selectedSession]);

            useEffect(() => { 
                setTimeout(() => { try { lucide.createIcons(); } catch(e){} }, 100);
            }, [view, scanResult, participants, users, sessions, rundown, editingId, messages, editingMessageId, isLogoutModalOpen, isInstallModalOpen, deleteConfig, notification, isDownloading, adminResetConfig]);

            const saveToCloud = (path, data) => {
                if (!window.db) return alert("Belum terkoneksi internet/database!");
                window.dbSet(window.dbRef(window.db, path), data).catch(err => alert("Gagal Simpan: " + err.message));
            };

            const initiateDelete = (path) => {
                setDeleteConfig({ show: true, path: path });
            };

            const performDelete = () => {
                if (!window.db || !deleteConfig.path) return;
                const ref = window.dbRef(window.db, deleteConfig.path);
                window.dbRemove(ref)
                    .then(() => {
                        setDeleteConfig({ show: false, path: null });
                    })
                    .catch(err => {
                        alert("Gagal menghapus: " + err.message);
                        setDeleteConfig({ show: false, path: null });
                    });
            };

            const deleteFromCloud = (path) => {
                initiateDelete(path);
            };

            const handleResetAllData = () => {
                if (prompt("PERINGATAN ADMIN!\n\nKetik 'HAPUS' untuk menghapus SEMUA Data Peserta & Absensi.") === 'HAPUS') {
                    window.dbRemove(window.dbRef(window.db, 'participants'));
                    window.dbRemove(window.dbRef(window.db, 'attendance'));
                    alert("DATABASE BERHASIL DIRESET.");
                } else { alert("Dibatalkan."); }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;
                const userFound = users.find(u => u.username === username && u.password === password);
                if (userFound) {
                    setCurrentUser(userFound);
                    localStorage.setItem('gkps_user', JSON.stringify(userFound)); 
                    setView('menu');
                } else { alert("Username atau Password Salah!"); }
            };

            const handleLogoutClick = () => setIsLogoutModalOpen(true);
            const performLogout = () => {
                setCurrentUser(null);
                localStorage.removeItem('gkps_user'); 
                setIsLogoutModalOpen(false);
                setView('login');
            };

            // --- FITUR RESET PASSWORD (LOGIN SCREEN - ONLY FOR ADMIN) ---
            const handleResetPassword = () => {
                const { username, newPassword, token } = resetForm;
                if (!username || !newPassword || !token) return alert("Mohon lengkapi semua kolom!");

                // Validasi: Fitur ini hanya untuk 'admin'
                if (username !== 'admin') {
                    return alert("Fitur reset mandiri hanya untuk Akun Admin Utama.\n\nJika Anda Peserta/Panitia dan lupa password, silakan hubungi Admin untuk di-reset dari Menu Admin.");
                }

                // Kode Otorisasi "Master Key"
                const MASTER_TOKEN = "GKPS-2025"; 

                if (token !== MASTER_TOKEN) {
                    return alert("Kode Otorisasi Salah! Hubungi Panitia Inti.");
                }

                const userExists = users.find(u => u.username === username);
                if (!userExists) {
                    return alert("Username admin tidak ditemukan!");
                }

                // Update password
                const updatedUser = { ...userExists, password: newPassword };
                saveToCloud(`users/${username}`, updatedUser);
                
                alert("Password Admin berhasil direset! Silakan login.");
                setView('login');
            };
            
            // --- FITUR RESET PASSWORD OLEH ADMIN (DI DALAM MENU) ---
            const initiateAdminReset = (user) => {
                setAdminResetConfig({ show: true, user: user, newPass: '' });
            };

            const performAdminReset = () => {
                const { user, newPass } = adminResetConfig;
                if(!newPass || newPass.length < 3) return alert("Password minimal 3 karakter!");
                
                const updatedUser = { ...user, password: newPass };
                saveToCloud(`users/${user.username}`, updatedUser);
                
                // Jika mereset diri sendiri, update state
                if(currentUser && currentUser.username === user.username) {
                    setCurrentUser(updatedUser);
                    localStorage.setItem('gkps_user', JSON.stringify(updatedUser));
                }
                
                setAdminResetConfig({ show: false, user: null, newPass: '' });
                alert(`Password untuk ${user.username} berhasil direset!`);
            };

            const LogoutModal = () => (
                <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-bounce-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center">
                        <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="log-out" className="text-red-600 w-8 h-8"></i></div>
                        <h3 className="text-xl font-bold text-slate-800 mb-2">Konfirmasi Keluar</h3>
                        <p className="text-slate-600 mb-6">Yakin ingin keluar aplikasi?</p>
                        <div className="flex gap-3">
                            <button onClick={() => setIsLogoutModalOpen(false)} className="flex-1 py-3 px-4 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition">Batal</button>
                            <button onClick={performLogout} className="flex-1 py-3 px-4 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 transition shadow-lg">Ya, Keluar</button>
                        </div>
                    </div>
                </div>
            );

            const DeleteConfirmModal = () => (
                <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-bounce-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center border-4 border-rose-100">
                        <div className="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="trash-2" className="text-rose-600 w-8 h-8"></i>
                        </div>
                        <h3 className="text-xl font-black text-slate-800 mb-2 font-fredoka">Hapus Data Ini?</h3>
                        <p className="text-slate-600 mb-6 font-medium">Data yang dihapus tidak bisa dikembalikan loh!</p>
                        <div className="flex gap-3">
                            <button onClick={() => setDeleteConfig({ show: false, path: null })} className="flex-1 py-3 px-4 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition">Jangan</button>
                            <button onClick={performDelete} className="flex-1 py-3 px-4 rounded-xl font-bold text-white bg-rose-500 hover:bg-rose-600 transition shadow-lg shadow-rose-200">Hapus Aja</button>
                        </div>
                    </div>
                </div>
            );
            
            const AdminResetModal = () => (
                <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-bounce-in">
                    <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm text-center border-4 border-orange-100">
                        <button onClick={() => setAdminResetConfig({ show: false, user: null, newPass: '' })} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" width="24"></i></button>
                        <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-orange-50">
                            <i data-lucide="key-round" className="text-orange-500 w-8 h-8"></i>
                        </div>
                        <h3 className="text-xl font-black text-slate-800 mb-1 font-fredoka">Reset Password</h3>
                        <p className="text-sm text-slate-500 mb-6">User: <b>{adminResetConfig.user?.username}</b></p>
                        
                        <input type="text" placeholder="Masukkan Password Baru..." className="w-full p-4 border-2 border-slate-200 rounded-xl mb-4 focus:outline-none focus:border-orange-400 bg-slate-50 font-bold text-slate-700 text-center" 
                            value={adminResetConfig.newPass} onChange={e => setAdminResetConfig({...adminResetConfig, newPass: e.target.value})} />
                            
                        <button onClick={performAdminReset} className="w-full btn-playful btn-orange py-3 rounded-xl font-black text-lg shadow-lg">Simpan Password</button>
                    </div>
                </div>
            );

            const InstallModal = () => (
                <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-bounce-in">
                    <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm text-center border-4 border-white/50 relative">
                        <button onClick={() => setIsInstallModalOpen(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" width="24"></i></button>
                        <div className="w-16 h-16 bg-sky-100 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-sky-50"><i data-lucide="download" className="text-sky-500 w-8 h-8"></i></div>
                        <h3 className="text-xl font-black text-slate-800 mb-4 font-fredoka">Pasang Aplikasi</h3>
                        <div className="text-left bg-slate-50 p-4 rounded-xl mb-3 border-2 border-slate-100">
                            <h4 className="font-bold text-slate-700 flex items-center gap-2 mb-2"><i data-lucide="smartphone" width="16"></i> Android (Chrome)</h4>
                            <p className="text-xs text-slate-500">1. Klik titik tiga (⋮) di pojok kanan atas browser.</p>
                            <p className="text-xs text-slate-500">2. Pilih <b>"Tambahkan ke Layar Utama"</b> atau <b>"Install App"</b>.</p>
                        </div>
                        <div className="text-left bg-slate-50 p-4 rounded-xl mb-4 border-2 border-slate-100">
                            <h4 className="font-bold text-slate-700 flex items-center gap-2 mb-2"><i data-lucide="apple" width="16"></i> iPhone (Safari)</h4>
                            <p className="text-xs text-slate-500">1. Klik tombol <b>Share</b> (kotak panah atas) di bawah.</p>
                            <p className="text-xs text-slate-500">2. Geser & pilih <b>"Add to Home Screen"</b> (Tambah ke Utama).</p>
                        </div>
                        <button onClick={() => setIsInstallModalOpen(false)} className="w-full btn-playful btn-blue py-3 rounded-xl font-bold">Siap, Mengerti!</button>
                    </div>
                </div>
            );

            const handleChangeSelfPassword = () => {
                if(!selfPassword || selfPassword.length < 3) return alert("Password minimal 3 karakter!");
                const updatedUser = { ...currentUser, password: selfPassword };
                saveToCloud(`users/${currentUser.username}`, updatedUser);
                setCurrentUser(updatedUser);
                localStorage.setItem('gkps_user', JSON.stringify(updatedUser)); 
                setSelfPassword('');
                alert("Password berhasil diubah!");
                handleBackToMenu();
            };

            const handleSendMessage = () => {
                if(!messageInput) return alert("Tuliskan pesan Anda!");
                if (editingMessageId) {
                    const msg = messages.find(m => m.id === editingMessageId);
                    if(msg) { saveToCloud(`messages/${editingMessageId}`, { ...msg, text: messageInput }); alert("Pesan diperbarui!"); }
                    setEditingMessageId(null);
                } else {
                    const id = `MSG-${Date.now()}`;
                    saveToCloud(`messages/${id}`, { id, text: messageInput, sender: currentUser.nama || currentUser.username, senderUsername: currentUser.username, role: currentUser.role, timestamp: new Date().toLocaleString('id-ID') });
                    alert("Pesan terkirim!");
                }
                setMessageInput('');
            };
            const startEditMessage = (m) => { setMessageInput(m.text); setEditingMessageId(m.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelEditMessage = () => { setMessageInput(''); setEditingMessageId(null); };

            const handleAddOrUpdateUser = () => {
                if(!newUser.username || !newUser.password) return alert("Lengkapi data user!");
                saveToCloud(`users/${newUser.username}`, newUser);
                setNewUser({ username: '', password: '', role: 'petugas', nama: '' });
                setEditingId(null); alert(editingId ? "User diupdate!" : "User ditambahkan!");
            };
            const startEditUser = (u) => { setNewUser(u); setEditingId(u.username); window.scrollTo({ top: 0, behavior: 'smooth' }); };

            const handleAddOrUpdateSession = () => {
                const { title, date, time } = sessionForm;
                if(!title || !date || !time) return alert("Mohon lengkapi Data Sesi!");
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const finalName = `${title}, ${formattedDate} Jam ${time} WIB`;
                const id = editingId || `SESS-${Date.now()}`;
                saveToCloud(`sessions/${id}`, { id, name: finalName, title, date, time, createdAt: Date.now() });
                setSessionForm({ title: '', date: '', time: '' }); setEditingId(null);
                alert(editingId ? "Sesi diupdate!" : "Sesi baru dibuat!");
            };
            const startEditSession = (s) => { setSessionForm({ title: s.title || '', date: s.date || '', time: s.time || '' }); setEditingId(s.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };

            const handleAddOrUpdateRundown = () => {
                if(!rundownForm.date || !rundownForm.time || !rundownForm.activity) return alert("Lengkapi Jadwal!");
                const id = editingId || `RUN-${Date.now()}`;
                saveToCloud(`rundown/${id}`, { id, completed: false, ...rundownForm });
                setRundownForm({ date: '', time: '', activity: '' }); setEditingId(null);
                alert(editingId ? "Jadwal diupdate!" : "Jadwal ditambahkan!");
            };
            const startEditRundown = (r) => { setRundownForm({ date: r.date, time: r.time, activity: r.activity }); setEditingId(r.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const toggleRundownCheck = (r) => { saveToCloud(`rundown/${r.id}`, { ...r, completed: !r.completed }); };

            const handleAddOrUpdateParticipant = () => {
                if(!formData.nama) return;
                const id = editingId || `M-${Date.now()}`;
                saveToCloud(`participants/${id}`, { id, nama: formData.nama, kategori: formData.kategori, kelas: formData.kelas });
                setFormData({nama:'', kategori:'Anak Sekolah Minggu', kelas: ''}); setEditingId(null); if(editingId) setShowAddForm(false); alert("Tersimpan!");
            };
            const startEditParticipant = (p) => { setFormData({ nama: p.nama, kategori: p.kategori, kelas: p.kelas || '' }); setEditingId(p.id); setShowAddForm(true); window.scrollTo({ top: 0, behavior: 'smooth' }); };

            const formatShortDate = (dateString) => { if(!dateString) return '-'; const d = new Date(dateString); return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }); };

            const generateQRUrl = (id) => `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${id}`;
            const getSessionName = (id) => sessions.find(s => s.id === id)?.name || 'Unknown Session';
            const downloadSingleQR = async (p) => {
                try {
                    const scrollPos = window.scrollY; const res = await fetch(generateQRUrl(p.id)); const blob = await res.blob();
                    const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `QR_${p.nama.replace(/\s+/g, '_')}.png`; link.style.display = 'none';
                    document.body.appendChild(link); link.click(); document.body.removeChild(link); window.scrollTo(0, scrollPos);
                } catch (e) { window.open(generateQRUrl(p.id), '_blank'); }
            };
            const downloadAllQR = async () => {
                if (participants.length === 0) return; setIsDownloading(true); 
                // Removed alert here
                const scrollPos = window.scrollY;
                for (const p of participants) { try {
                    const res = await fetch(generateQRUrl(p.id)); const blob = await res.blob(); const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob); link.download = `QR_${p.nama.replace(/\s+/g, '_')}.png`; link.style.display = 'none';
                    document.body.appendChild(link); link.click(); document.body.removeChild(link); await new Promise(r => setTimeout(r, 600));
                } catch (e) {} }
                window.scrollTo(0, scrollPos); setIsDownloading(false); alert("Selesai!");
            };
            const handleCSV = (e) => {
                const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                reader.onload = (ev) => {
                    const lines = ev.target.result.split('\n').filter(l => l.trim()); let count = 0;
                    lines.slice(1).forEach((line, idx) => {
                        const [nama, kategori, kelas] = line.split(',').map(s => s?.trim());
                        if (nama) {
                            const id = `GSM-${Date.now()}-${idx}`;
                            saveToCloud(`participants/${id}`, { id, nama, kategori: kategori || 'Umum', kelas: kelas || '-' }); count++;
                        }
                    }); alert(`Mengupload ${count} data...`);
                }; reader.readAsText(file);
            };

            // --- SCANNER LOGIC ---
            useEffect(() => { if (view === 'scan' && !scanResult) { setTimeout(startScanner, 300); return () => stopScanner(); } }, [view, scanResult]);
            const startScanner = () => { if (scannerRef.current) scannerRef.current.clear().catch(()=>{}); const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, aspectRatio: 1.0 }, false); scanner.render((decodedText) => { handleScanSuccess(decodedText); scanner.clear(); }, (error) => {}); scannerRef.current = scanner; };
            const stopScanner = () => { if (scannerRef.current) { try { scannerRef.current.clear(); } catch(e){} scannerRef.current = null; } };

            const handleScanSuccess = (qrId) => {
                if (!selectedSession) { 
                    setScanResult({ success: false, msg: 'ERROR: Pilih Sesi Terlebih Dahulu!' });
                    setNotification('⚠️ Pilih Sesi dulu ya!');
                    playErrorSound();
                    return; 
                }
                const p = participants.find(item => item.id === qrId);
                const fallbackP = !p ? { id: qrId, nama: 'Unknown / User', kategori: 'Manual Scan', kelas: '-' } : p;
                
                if (!p) { 
                    setScanResult({ success: false, msg: 'QR Tidak Terdaftar di Database Peserta!' }); 
                    playErrorSound(); 
                    return; 
                }
                
                const exist = attendance.find(item => item.id === qrId);
                if (exist) { 
                    setScanResult({ success: false, msg: 'Sudah Check-in di Sesi Ini', p: fallbackP, time: exist.timestamp }); 
                    playErrorSound();
                    return; 
                }
                
                const now = new Date();
                const newAtt = { ...fallbackP, id: qrId, timestamp: now.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }), device: currentUser?.username || 'Unknown', sessionId: selectedSession };
                saveToCloud(`attendance/${selectedSession}/${qrId}`, newAtt);
                setScanResult({ success: true, msg: 'Check-in Berhasil!', p: newAtt, time: newAtt.timestamp });
                
                setNotification(`✅ ${newAtt.nama} Berhasil Masuk!`);
                playFunnySound();
                setTimeout(() => setNotification(null), 3000);
            };

            // --- MENU UTAMA ---
            const safeUser = currentUser || { nama: 'Guest', role: 'peserta' };
            const isAdmin = safeUser.role === 'admin';
            const isPanitia = safeUser.role === 'panitia';
            const isPeserta = safeUser.role === 'peserta';
            const canEditRundown = true; 

            // VIEW: FORGOT PASSWORD
            if (view === 'forgot_password') return (
                <div className="min-h-screen bg-school-sunday flex items-center justify-center p-4">
                    <div className="glass-panel p-8 rounded-[30px] shadow-2xl w-full max-w-sm animate-bounce-in border-4 border-white/50">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-rose-50">
                                <i data-lucide="key-round" className="text-rose-500 w-8 h-8"></i>
                            </div>
                            <h1 className="text-2xl font-black text-rose-500 drop-shadow-sm" style={{fontFamily: 'Fredoka, sans-serif'}}>Reset Password</h1>
                            <p className="text-slate-500 font-bold text-xs mt-1">Khusus Akun Admin Utama</p>
                        </div>
                        
                        <div className="space-y-3">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Username Admin</label>
                                <input className="w-full p-3 border-2 border-indigo-100 rounded-xl bg-white focus:outline-none focus:border-rose-400 focus:ring-0 transition font-bold text-slate-700" 
                                    placeholder="Username Anda" value={resetForm.username} onChange={e => setResetForm({...resetForm, username: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Password Baru</label>
                                <input type="password" className="w-full p-3 border-2 border-indigo-100 rounded-xl bg-white focus:outline-none focus:border-rose-400 focus:ring-0 transition font-bold text-slate-700" 
                                    placeholder="***" value={resetForm.newPassword} onChange={e => setResetForm({...resetForm, newPassword: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Kode Otorisasi</label>
                                <input type="password" className="w-full p-3 border-2 border-indigo-100 rounded-xl bg-white focus:outline-none focus:border-rose-400 focus:ring-0 transition font-bold text-slate-700" 
                                    placeholder="Kode Master Panitia" value={resetForm.token} onChange={e => setResetForm({...resetForm, token: e.target.value})} />
                            </div>
                            
                            <button onClick={handleResetPassword} className="w-full btn-playful btn-orange py-3 rounded-xl font-black text-lg shadow-lg shadow-orange-100 mt-2">Reset Password</button>
                            <button onClick={() => setView('login')} className="w-full text-slate-400 font-bold text-xs py-2 hover:text-slate-600 transition">Batal, kembali ke Login</button>
                        </div>
                    </div>
                </div>
            );

            // VIEW: MANAGE RUNDOWN
            if (view === 'manage_rundown') return (
                 <div key="view-manage_rundown" className="min-h-screen bg-slate-50 p-4">
                    <div className="max-w-md mx-auto">
                        <button onClick={handleBackToMenu} className="mb-4 btn-playful btn-white px-4 py-2 rounded-xl w-fit flex gap-2 font-bold"><i data-lucide="arrow-left"></i> Kembali</button>
                        
                        {!isPeserta && (
                            <div className="bg-white rounded-3xl shadow-lg p-6 mb-8 border-2 border-slate-100 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-4 opacity-5"><i data-lucide="calendar" width="100" height="100"></i></div>
                                <h2 className="font-black text-lg mb-4 flex gap-2 items-center text-slate-700 relative z-10">
                                    {editingId ? 'Edit Jadwal' : 'Tambah Jadwal'}
                                </h2>
                                <div className="space-y-3 relative z-10">
                                    <div className="flex gap-2">
                                        <input type="date" className="flex-1 w-full border-2 p-3 rounded-xl font-bold text-slate-600 focus:border-cyan-400 outline-none" value={rundownForm.date} onChange={e => setRundownForm({...rundownForm, date: e.target.value})} />
                                        <input type="time" className="w-24 border-2 p-3 rounded-xl font-bold text-slate-600 focus:border-cyan-400 outline-none" value={rundownForm.time} onChange={e => setRundownForm({...rundownForm, time: e.target.value})} />
                                    </div>
                                    <input placeholder="Nama Kegiatan" className="w-full border-2 p-3 rounded-xl font-bold text-slate-600 focus:border-cyan-400 outline-none" value={rundownForm.activity} onChange={e => setRundownForm({...rundownForm, activity: e.target.value})} />
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={handleAddOrUpdateRundown} className={`flex-1 btn-playful py-3 rounded-xl font-bold ${editingId ? 'btn-orange' : 'btn-blue'}`}>
                                            {editingId ? 'Update' : 'Simpan'}
                                        </button>
                                        {editingId && <button onClick={() => { setEditingId(null); setRundownForm({ date: '', time: '', activity: '' }); }} className="btn-playful btn-white px-4 rounded-xl font-bold">Batal</button>}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <div className="relative pb-20 mt-4 timeline-container">
                             {/* Garis Timeline Warna-warni */}
                             <div className="timeline-line-colorful"></div>

                            {rundown.map((r, index) => {
                                // Cycle colors for cards
                                const colorTheme = rundownColors[index % rundownColors.length];
                                
                                return (
                                    <div key={r.id} className="relative pl-28 mb-6 timeline-item">
                                        {/* JAM DI SISI KIRI (Tidak tertutup dot) */}
                                        <div className="absolute left-0 top-6 w-16 text-right pr-2">
                                            <span className="block font-black text-sm text-slate-500 font-fredoka">{r.time}</span>
                                        </div>

                                        {/* DOT (Di tengah garis timeline di 80px) */}
                                        {/* Center of line is 80px + 2px = 82px. Dot width 20px (w-5). Left = 82 - 10 = 72px */}
                                        <div className={`absolute left-[72px] top-[26px] w-5 h-5 rounded-full border-4 border-white shadow-md z-10 ${r.completed ? 'bg-slate-400' : colorTheme.icon}`}></div>
                                        
                                        <div className={`p-5 rounded-3xl shadow-sm border-b-4 transition-all duration-300 relative overflow-hidden group ${r.completed ? 'bg-slate-100 border-slate-200 opacity-80' : `${colorTheme.bg} ${colorTheme.border}`}`}>
                                            
                                            {/* Completed Stamp Effect */}
                                            {r.completed && (
                                                <div className="absolute right-[-10px] top-[-10px] opacity-20 transform rotate-12 pointer-events-none">
                                                    <div className="border-4 border-slate-800 rounded-lg p-2 font-black text-4xl text-slate-800">SELESAI</div>
                                                </div>
                                            )}

                                            <div className="relative z-10">
                                                <p className="text-[10px] font-black uppercase text-slate-500 tracking-wider mb-1 bg-white/40 inline-block px-2 rounded">{formatShortDate(r.date)}</p>
                                                <h3 className={`font-black text-xl leading-tight font-fredoka ${r.completed ? 'text-slate-500 line-through decoration-4 decoration-slate-300' : colorTheme.text}`}>
                                                    {r.activity}
                                                </h3>
                                            </div>
                                            
                                            <div className="flex items-center justify-between mt-4 border-t border-black/5 pt-3">
                                                {/* TOMBOL TANDAI SELESAI YANG JELAS (Akses untuk semua) */}
                                                {canEditRundown && (
                                                    <button 
                                                        onClick={() => toggleRundownCheck(r)} 
                                                        className={`flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-xl font-bold text-xs transition active:scale-95 shadow-sm ${r.completed ? 'bg-slate-200 text-slate-500 hover:bg-slate-300' : 'bg-white text-slate-700 hover:bg-white/80'}`}
                                                    >
                                                        {r.completed ? (
                                                            <><i data-lucide="rotate-ccw" width="14"></i> Batal Selesai</>
                                                        ) : (
                                                            <><i data-lucide="check-circle-2" width="14" className="text-emerald-500"></i> Tandai Selesai</>
                                                        )}
                                                    </button>
                                                )}

                                                {!isPeserta && (
                                                    <div className="flex gap-2 ml-2">
                                                        <button onClick={() => startEditRundown(r)} className="bg-white/50 text-blue-600 p-2 rounded-xl hover:bg-white transition"><i data-lucide="pencil" width="14"></i></button>
                                                        <button onClick={() => initiateDelete(`rundown/${r.id}`)} className="bg-white/50 text-rose-500 p-2 rounded-xl hover:bg-white transition"><i data-lucide="trash-2" width="14"></i></button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            
                            {rundown.length === 0 && (
                                <div className="text-center py-20 opacity-50">
                                    <i data-lucide="calendar-x" className="mx-auto mb-2 w-16 h-16 text-slate-300"></i>
                                    <p className="text-slate-400 font-bold text-sm">Belum ada jadwal acara.</p>
                                </div>
                            )}
                        </div>
                    </div>
                    {deleteConfig.show && <DeleteConfirmModal />}
                 </div>
            );

            // ... (Rest of views remain the same, simplified here for context)
            if (view === 'login') return (
                <div key="view-login" className="min-h-screen bg-school-sunday flex items-center justify-center p-4">
                    <div className="glass-panel p-8 rounded-[30px] shadow-2xl w-full max-w-sm animate-bounce-in border-4 border-white/50">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-black text-orange-500 drop-shadow-sm" style={{fontFamily: 'Fredoka, sans-serif'}}>Login Sistem</h1>
                            <p className="text-slate-500 font-bold text-sm mt-1 bg-white/50 inline-block px-3 py-1 rounded-full">Retreat GSM GKPS</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Username</label><input name="username" className="w-full p-4 border-2 border-indigo-100 rounded-2xl bg-white focus:outline-none focus:border-indigo-400 focus:ring-0 transition font-bold text-slate-700 placeholder-Ketik username..." required/></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Password</label><input type="password" name="password" className="w-full p-4 border-2 border-indigo-100 rounded-2xl bg-white focus:outline-none focus:border-indigo-400 focus:ring-0 transition font-bold text-slate-700 placeholder-***" required/></div>
                            <button type="submit" className="w-full btn-playful btn-blue font-black py-4 rounded-2xl text-lg shadow-lg shadow-sky-200 mt-2">MASUK YUK!</button>
                            
                            <button type="button" onClick={() => setView('forgot_password')} className="text-orange-500 font-bold text-xs hover:text-orange-600 underline text-right block w-full mt-2">Lupa Password?</button>
                        </form>
                        <div className="mt-6 text-center text-xs font-bold bg-white/40 py-2 rounded-xl">
                            {isConnected ? <span className="text-emerald-500 flex items-center justify-center gap-1"><i data-lucide="wifi" width="14"></i> Terhubung ke Cloud</span> : <span className="text-rose-500 animate-pulse">● Menghubungkan...</span>}
                        </div>
                    </div>
                </div>
            );

            if (view === 'menu') return (
                <div key="view-menu" className="min-h-screen bg-school-sunday p-4 pt-8 pb-20 relative">
                     {notification && (
                        <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[150] w-full max-w-sm px-4 animate-shake">
                            <div className="bg-yellow-300 border-4 border-yellow-500 text-yellow-900 px-6 py-4 rounded-2xl shadow-xl flex items-center gap-4 animate-bounce-in">
                                <div className="bg-white p-2 rounded-full shadow-sm"><i data-lucide="info" className="text-yellow-600"></i></div>
                                <span className="font-bold text-sm leading-tight font-fredoka">{notification}</span>
                            </div>
                        </div>
                    )}
                    <div className="max-w-md mx-auto glass-panel rounded-[32px] overflow-hidden border-2 border-white/60">
                        <div className="bg-gradient-to-r from-orange-300 to-pink-300 p-6 text-white relative">
                            <div className="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="sun" width="80" height="80"></i></div>
                            <div className="flex justify-between items-center relative z-10">
                                <div><p className="text-white/80 text-xs font-bold mb-1">Selamat Datang,</p><h1 className="text-3xl font-black drop-shadow-md tracking-tight" style={{fontFamily: 'Fredoka, sans-serif'}}>{safeUser.nama}</h1><span className="text-[10px] font-black uppercase tracking-wider bg-white/25 inline-block px-3 py-1 rounded-full mt-2 border border-white/30 backdrop-blur-sm">{safeUser.role}</span></div>
                                <button onClick={handleLogoutClick} className="bg-white/20 hover:bg-white/30 p-3 rounded-2xl text-white transition flex items-center justify-center shadow-inner border border-white/30" title="Keluar"><i data-lucide="log-out" width="20"></i></button>
                            </div>
                        </div>
                        <div className="p-6 space-y-4">
                            <button onClick={() => setView('my_barcode')} className="w-full btn-playful bg-gradient-to-r from-sky-400 to-blue-500 border-b-4 border-blue-700 text-white p-4 rounded-2xl flex items-center gap-4 shadow-lg hover:shadow-sky-200 transform hover:scale-[1.01]">
                                <div className="bg-white/20 p-3 rounded-xl border-2 border-white/30"><i data-lucide="qr-code" width="28" height="28"></i></div>
                                <div className="text-left"><h3 className="font-bold text-xl font-fredoka">Tiket Saya</h3><p className="text-xs text-blue-100 font-bold opacity-90">Tunjukkan Barcode</p></div>
                            </button>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setView('manage_rundown')} className="btn-playful btn-white border-b-4 border-slate-200 p-4 rounded-2xl flex flex-col items-center gap-2 shadow-sm h-full justify-center">
                                    <div className="bg-sky-100 p-3 rounded-full text-sky-500 mb-1"><i data-lucide="list-clock" width="24"></i></div><span className="font-bold text-slate-600 text-sm">Jadwal Acara</span>
                                </button>
                                <button onClick={() => setView('messages')} className="btn-playful btn-white border-b-4 border-slate-200 p-4 rounded-2xl flex flex-col items-center gap-2 shadow-sm h-full justify-center">
                                    <div className="bg-amber-100 p-3 rounded-full text-amber-500 mb-1"><i data-lucide="message-circle" width="24"></i></div><span className="font-bold text-slate-600 text-sm">Pesan & Kesan</span>
                                </button>
                            </div>
                             {!isPeserta && (
                                <div className="bg-slate-50 p-4 rounded-3xl border-2 border-dashed border-slate-200 mt-4">
                                    <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-3 text-center">Menu Panitia</h4>
                                    {isAdmin && (
                                        <div className="grid grid-cols-2 gap-3 mb-3">
                                            <button onClick={() => setView('manage_sessions')} className="btn-playful btn-purple rounded-xl p-3 text-xs font-bold flex flex-col items-center gap-2 border-b-4 border-violet-700"><i data-lucide="calendar-clock"></i> Atur Sesi</button>
                                            <button onClick={() => setView('manage_users')} className="btn-playful btn-blue rounded-xl p-3 text-xs font-bold flex flex-col items-center gap-2 border-b-4 border-sky-700"><i data-lucide="user-cog"></i> Atur User</button>
                                        </div>
                                    )}
                                    {isAdmin && (
                                        <button onClick={() => setView('generate')} className="w-full btn-playful btn-white border-b-4 mb-3 p-3 rounded-xl flex items-center gap-3"><div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-lucide="database" width="18"></i></div><div className="text-left text-xs"><h3 className="font-bold text-slate-700">Database Peserta</h3></div></button>
                                    )}
                                    <button onClick={() => setView('scan')} className="w-full btn-playful bg-slate-800 text-white border-b-4 border-slate-950 p-4 rounded-xl flex items-center gap-3 shadow-lg mb-3"><div className="bg-white/20 p-2 rounded-lg"><i data-lucide="camera" width="20"></i></div><div className="text-left"><h3 className="font-bold">Mulai Scan Absensi</h3><p className="text-[10px] text-slate-400">Mode Kamera</p></div></button>
                                    <button onClick={() => setView('report')} className="w-full btn-playful btn-orange border-b-4 border-orange-600 p-3 rounded-xl flex items-center gap-3 shadow-sm"><div className="bg-white/20 p-2 rounded-lg"><i data-lucide="file-spreadsheet" width="18"></i></div><div className="text-left text-xs"><h3 className="font-bold">Laporan Kehadiran</h3></div></button>
                                    {isAdmin && (
                                        <button onClick={handleResetAllData} className="w-full mt-4 btn-playful bg-rose-100 text-rose-600 border-b-4 border-rose-200 hover:bg-rose-200 p-3 rounded-xl flex items-center justify-center gap-2"><i data-lucide="alert-octagon" width="14"></i><span className="font-black text-[10px]">RESET DATABASE</span></button>
                                    )}
                                </div>
                            )}
                            <button onClick={() => setView('change_password')} className="w-full py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition flex items-center justify-center gap-2"><i data-lucide="lock" width="12"></i> Ganti Password Saya</button>
                            <button onClick={() => setIsInstallModalOpen(true)} className="w-full py-2 text-indigo-400 text-[10px] font-bold hover:text-indigo-600 transition flex items-center justify-center gap-1"><i data-lucide="smartphone" width="10"></i> Cara Install Aplikasi</button>
                        </div>
                    </div>
                     {isLogoutModalOpen && <LogoutModal />}
                    {isInstallModalOpen && <InstallModal />}
                    {adminResetConfig.show && <AdminResetModal />}
                </div>
            );

            // --- Other views truncated for brevity as they use standard structure ---
            if (view === 'my_barcode') { /* ...Same as previous... */ 
               const myParticipantData = participants.find(p => p.nama.toLowerCase() === currentUser.nama.toLowerCase()) || { id: currentUser.username, nama: currentUser.nama, kategori: currentUser.role, kelas: '-' };
                return (<div className="min-h-screen bg-school-sunday p-6 flex flex-col items-center justify-center"><div className="w-full max-w-sm"><div className="flex justify-between items-center mb-6"><button onClick={handleBackToMenu} className="btn-playful bg-white text-slate-700 font-bold flex items-center gap-2 py-2 px-4 rounded-xl shadow-sm border-b-4 border-slate-200"><i data-lucide="arrow-left" width="18"></i> Kembali</button><button onClick={handleLogoutClick} className="btn-playful bg-rose-100 text-rose-600 font-bold flex items-center gap-2 py-2 px-4 rounded-xl shadow-sm border-b-4 border-rose-200"><i data-lucide="log-out" width="18"></i></button></div><div className="barcode-card rounded-[32px] shadow-2xl overflow-hidden relative text-white border-[6px] border-white ring-4 ring-orange-200/50"><div className="p-6 text-center border-b border-white/20 relative bg-white/10 backdrop-blur-sm"><h2 className="text-3xl font-black tracking-wide uppercase drop-shadow-md" style={{fontFamily: 'Fredoka, sans-serif'}}>Kartu Peserta</h2><p className="text-sm font-bold opacity-90 tracking-widest bg-black/10 inline-block px-3 rounded-full mt-1">GKPS Tangerang</p></div><div className="bg-white p-8 flex flex-col items-center justify-center gap-6 relative"><div className="bg-white p-4 rounded-3xl border-4 border-dashed border-sky-200 shadow-inner"><img src={generateQRUrl(myParticipantData.id)} alt="My QR" className="w-48 h-48 object-contain mix-blend-multiply" /></div><div className="text-center w-full"><div className="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 w-full"><p className="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-1">Nama Lengkap</p><h3 className="text-2xl font-black text-slate-800 leading-tight mb-3 font-fredoka">{myParticipantData.nama}</h3><div className="flex justify-center gap-2 flex-wrap"><span className="bg-sky-100 text-sky-700 text-xs px-3 py-1.5 rounded-lg font-bold uppercase border-b-2 border-sky-200">{myParticipantData.kategori}</span>{myParticipantData.kelas !== '-' && <span className="bg-rose-100 text-rose-700 text-xs px-3 py-1.5 rounded-lg font-bold uppercase border-b-2 border-rose-200">{myParticipantData.kelas}</span>}</div></div></div></div><div className="p-3 bg-indigo-500/90 backdrop-blur-sm text-center border-t border-white/10"><p className="text-[10px] font-bold opacity-90 text-indigo-100">Scan barcode ini saat masuk ruangan</p></div></div><div className="mt-8 text-center"><button onClick={() => downloadSingleQR(myParticipantData)} className="btn-playful btn-green py-3 px-6 rounded-2xl flex items-center justify-center gap-2 mx-auto text-sm font-bold shadow-lg shadow-emerald-200 border-b-4 border-emerald-600"><i data-lucide="download"></i> Simpan ke Galeri</button></div></div>{isLogoutModalOpen && <LogoutModal />}</div>);
            }
             if (view === 'change_password') return (<div className="min-h-screen bg-slate-50 p-4"><div className="max-w-md mx-auto"><button onClick={handleBackToMenu} className="mb-6 btn-playful bg-white text-slate-600 font-bold px-4 py-2 rounded-xl border-b-4 border-slate-200 flex items-center gap-2 w-fit"><i data-lucide="arrow-left" width="18"></i> Kembali</button><div className="bg-white rounded-3xl shadow-xl p-8 border-2 border-slate-100"><div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mb-4 text-orange-500 mx-auto border-4 border-orange-50"><i data-lucide="lock" width="32" height="32"></i></div><h2 className="font-black text-2xl mb-2 text-slate-800 text-center font-fredoka">Ganti Password</h2><p className="text-sm text-slate-400 mb-6 text-center font-bold">Akun: <span className="text-indigo-500">{currentUser?.username}</span></p><input type="password" placeholder="Ketik Password Baru..." className="w-full p-4 border-2 border-slate-200 rounded-xl mb-4 focus:outline-none focus:border-orange-400 bg-slate-50 font-bold text-slate-700" value={selfPassword} onChange={e => setSelfPassword(e.target.value)} /><button onClick={handleChangeSelfPassword} className="w-full btn-playful btn-orange py-4 rounded-xl font-black text-lg shadow-lg shadow-orange-100 mt-2">Simpan Perubahan</button></div></div></div>);
            if (view === 'messages') return (<div className="min-h-screen bg-yellow-50 p-4"><div className="max-w-md mx-auto"><button onClick={handleBackToMenu} className="mb-6 btn-playful bg-white text-slate-600 font-bold px-4 py-2 rounded-xl border-b-4 border-slate-200 flex items-center gap-2 w-fit"><i data-lucide="arrow-left" width="18"></i> Kembali</button><div className="bg-white rounded-3xl shadow-xl p-6 mb-6 border-2 border-yellow-100"><div className="flex items-center gap-3 mb-4"><div className="p-3 bg-yellow-100 rounded-full text-yellow-600"><i data-lucide="message-circle-heart"></i></div><h2 className="font-black text-xl text-slate-700 font-fredoka">{editingMessageId ? 'Edit Pesan' : 'Kirim Pesan'}</h2></div><textarea placeholder="Tuliskan pengalaman seru atau masukan kakak..." className="w-full border-2 border-slate-200 p-4 rounded-2xl mb-4 h-32 focus:outline-none focus:border-yellow-400 bg-slate-50 font-medium text-slate-700 resize-none" value={messageInput} onChange={e => setMessageInput(e.target.value)}></textarea><div className="flex gap-3"><button onClick={handleSendMessage} className={`flex-1 btn-playful py-3 rounded-xl font-bold transition shadow-md ${editingMessageId ? 'btn-orange' : 'btn-yellow'}`}>{editingMessageId ? 'Update' : 'Kirim Pesan'}</button>{editingMessageId && <button onClick={cancelEditMessage} className="btn-playful btn-white px-6 rounded-xl font-bold">Batal</button>}</div></div><div className="space-y-4 pb-20"><h3 className="font-black text-slate-400 ml-2 text-sm uppercase tracking-widest">Dinding Pesan ({messages.length})</h3>{messages.map(m => (<div key={m.id} className={`bg-white p-5 rounded-3xl shadow-sm border-2 relative ${editingMessageId === m.id ? 'border-orange-400 ring-4 ring-orange-100' : 'border-slate-100'}`}><div className="absolute top-5 right-5 flex gap-2">{m.senderUsername === currentUser.username && (<button onClick={() => startEditMessage(m)} className="text-sky-400 hover:text-sky-600 bg-sky-50 p-2 rounded-lg transition"><i data-lucide="pencil" width="14"></i></button>)}{(isAdmin || isPanitia || m.senderUsername === currentUser.username) && (<button onClick={() => deleteFromCloud(`messages/${m.id}`)} className="text-rose-400 hover:text-rose-600 bg-rose-50 p-2 rounded-lg transition"><i data-lucide="trash-2" width="14"></i></button>)}</div><div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-300 to-orange-400 flex items-center justify-center text-white font-bold text-xs shadow-sm">{m.sender.charAt(0)}</div><div><p className="font-bold text-slate-800 text-sm">{m.sender}</p><p className="text-[10px] font-bold text-slate-400 uppercase">{m.role} • {m.timestamp}</p></div></div><div className="bg-slate-50 p-3 rounded-2xl rounded-tl-none mt-1 border border-slate-100"><p className="text-slate-600 text-sm leading-relaxed">"{m.text}"</p></div></div>))}{messages.length === 0 && (<div className="text-center py-10 opacity-50"><i data-lucide="message-square-dashed" className="mx-auto mb-2 w-12 h-12 text-slate-300"></i><p className="text-slate-400 font-bold text-sm">Belum ada pesan nih.</p></div>)}</div></div></div>);
            
            // VIEW: MANAGE USERS (UPDATED)
            if (view === 'manage_users') return (
                <div key="view-manage_users" className="min-h-screen bg-slate-50 p-4">
                    <div className="max-w-md mx-auto">
                        <button onClick={handleBackToMenu} className="mb-4 btn-playful btn-white px-4 py-2 rounded-xl w-fit flex gap-2 font-bold"><i data-lucide="arrow-left"></i> Kembali</button>
                        <div className="bg-white rounded-3xl shadow-lg p-6 mb-4 border-2 border-slate-100">
                            <h2 className="font-black text-xl mb-4 flex gap-2 items-center text-slate-700">{editingId ? <><i data-lucide="edit" className="text-orange-500"></i> Edit User</> : <><i data-lucide="user-plus" className="text-blue-500"></i> Tambah User</>}</h2>
                            <div className="space-y-3">
                                <input placeholder="Username" disabled={!!editingId} className={`w-full border-2 p-3 rounded-xl focus:outline-none focus:border-blue-400 font-bold text-slate-600 ${editingId ? 'bg-slate-100' : 'bg-white'}`} value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} />
                                <input placeholder="Password" className="w-full border-2 p-3 rounded-xl focus:outline-none focus:border-blue-400 font-bold text-slate-600" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} />
                                <input placeholder="Nama Lengkap" className="w-full border-2 p-3 rounded-xl focus:outline-none focus:border-blue-400 font-bold text-slate-600" value={newUser.nama} onChange={e => setNewUser({...newUser, nama: e.target.value})} />
                                <select className="w-full border-2 p-3 rounded-xl focus:outline-none focus:border-blue-400 font-bold text-slate-600 bg-white" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})}>
                                    <option value="petugas">Petugas Scan</option><option value="admin">Admin</option><option value="panitia">Panitia</option><option value="peserta">Peserta</option>
                                </select>
                                <div className="flex gap-2 pt-2"><button onClick={handleAddOrUpdateUser} className={`flex-1 btn-playful py-3 rounded-xl font-bold ${editingId ? 'btn-orange' : 'btn-blue'}`}>{editingId ? 'Update / Reset' : 'Simpan User'}</button>{editingId && <button onClick={() => { setEditingId(null); setNewUser({ username: '', password: '', role: 'petugas', nama: '' }); }} className="btn-playful btn-white px-4 rounded-xl font-bold">Batal</button>}</div>
                            </div>
                        </div>
                        <div className="space-y-2 pb-10">
                            <h3 className="font-black text-slate-400 ml-2 text-xs uppercase tracking-widest">User Terdaftar</h3>
                            {users.map(u => (
                                <div key={u.username} className={`bg-white p-4 rounded-2xl shadow-sm border-2 flex justify-between items-center ${editingId === u.username ? 'border-orange-400 bg-orange-50' : 'border-slate-100'}`}>
                                    <div><p className="font-bold text-slate-700">{u.username}</p><p className="text-xs font-bold text-slate-400 bg-slate-100 inline-block px-2 rounded">{u.nama} • {u.role}</p></div>
                                    <div className="flex gap-2">
                                        <button onClick={() => startEditUser(u)} className="text-blue-500 bg-blue-50 p-2 rounded-lg hover:bg-blue-100 transition" title="Edit Data"><i data-lucide="pencil" width="16"></i></button>
                                        <button onClick={() => initiateAdminReset(u)} className="text-orange-500 bg-orange-50 p-2 rounded-lg hover:bg-orange-100 transition" title="Reset Password"><i data-lucide="key-round" width="16"></i></button>
                                        {u.username !== 'admin' && (<button onClick={() => initiateDelete(`users/${u.username}`)} className="text-rose-500 bg-rose-50 p-2 rounded-lg hover:bg-rose-100 transition" title="Hapus User"><i data-lucide="trash-2" width="16"></i></button>)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    {deleteConfig.show && <DeleteConfirmModal />}
                    {adminResetConfig.show && <AdminResetModal />}
                </div>
            );
            
            if (view === 'manage_sessions') return (<div key="view-manage_sessions" className="min-h-screen bg-slate-50 p-4"><div className="max-w-md mx-auto"><button onClick={handleBackToMenu} className="mb-4 btn-playful btn-white px-4 py-2 rounded-xl w-fit flex gap-2 font-bold"><i data-lucide="arrow-left"></i> Kembali</button><div className="bg-white rounded-3xl shadow-lg p-6 mb-4 border-2 border-slate-100"><h2 className="font-black text-lg mb-4 flex gap-2 items-center text-slate-700">{editingId ? <><i data-lucide="edit"></i> Edit Sesi</> : <><i data-lucide="calendar-plus"></i> Buat Sesi Baru</>}</h2><div className="space-y-3"><div><label className="text-xs font-bold text-gray-500 uppercase">Nama Kegiatan</label><input placeholder="Contoh: Makan Pagi" className="w-full border-2 p-3 rounded-xl font-bold text-slate-600 focus:border-cyan-400 outline-none" value={sessionForm.title} onChange={e => setSessionForm({...sessionForm, title: e.target.value})} /></div><div className="flex gap-2"><div className="flex-1"><label className="text-xs font-bold text-gray-500 uppercase">Tanggal</label><input type="date" className="w-full border-2 p-3 rounded-xl font-bold text-slate-600 focus:border-cyan-400 outline-none" value={sessionForm.date} onChange={e => setSessionForm({...sessionForm, date: e.target.value})} /></div><div className="flex-1"><label className="text-xs font-bold text-gray-500 uppercase">Jam / Waktu</label><input placeholder="07:00 - 08:00" className="w-full border-2 p-3 rounded-xl font-bold text-slate-600 focus:border-cyan-400 outline-none" value={sessionForm.time} onChange={e => setSessionForm({...sessionForm, time: e.target.value})} /></div></div><div className="flex gap-2 pt-2"><button onClick={handleAddOrUpdateSession} className={`flex-1 btn-playful py-3 rounded-xl font-bold ${editingId ? 'btn-orange' : 'btn-purple'}`}>{editingId ? 'Update Sesi' : 'Buat Sesi'}</button>{editingId && <button onClick={() => { setEditingId(null); setSessionForm({ title: '', date: '', time: '' }); }} className="btn-playful btn-white px-4 rounded-xl font-bold">Batal</button>}</div></div></div><div className="space-y-2 pb-10"><h3 className="font-black text-slate-400 ml-2 text-xs uppercase tracking-widest">Daftar Sesi</h3>{sessions.length === 0 && <p className="text-gray-400 text-center text-sm py-4">Belum ada sesi dibuat.</p>}{sessions.map(s => (<div key={s.id} className={`bg-white p-4 rounded-2xl shadow-sm border-2 flex justify-between items-start ${editingId === s.id ? 'border-orange-400 bg-orange-50' : 'border-purple-100'}`}><div><span className="font-bold text-slate-800 text-base block">{s.title}</span><div className="flex gap-2 text-xs text-gray-500 mt-1"><span className="flex items-center gap-1 font-bold bg-slate-100 px-2 py-1 rounded"><i data-lucide="calendar" width="12"></i> {formatShortDate(s.date)}</span><span className="flex items-center gap-1 font-bold bg-slate-100 px-2 py-1 rounded"><i data-lucide="clock" width="12"></i> {s.time}</span></div></div><div className="flex gap-2"><button onClick={() => startEditSession(s)} className="text-blue-500 bg-blue-50 p-2 rounded-lg hover:bg-blue-100 transition"><i data-lucide="pencil" width="16"></i></button><button onClick={() => initiateDelete(`sessions/${s.id}`)} className="text-rose-500 bg-rose-50 p-2 rounded-lg hover:bg-rose-100 transition"><i data-lucide="trash-2" width="16"></i></button></div></div>))}</div></div>{deleteConfig.show && <DeleteConfirmModal />}</div>);
            if (view === 'generate') return (<div key="view-generate" className="min-h-screen bg-slate-100 p-4"><div className="max-w-md mx-auto"><button onClick={handleBackToMenu} className="mb-4 btn-playful btn-white px-4 py-2 rounded-xl w-fit flex gap-2 font-bold"><i data-lucide="arrow-left"></i> Kembali</button><div className="bg-white rounded-xl shadow p-6"><h2 className="font-bold text-xl mb-6 text-indigo-800 flex items-center gap-2"><i data-lucide="users"></i> Data Peserta</h2><div className="mb-6 space-y-4"><div className="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center relative hover:bg-slate-50 transition"><input type="file" accept=".csv" onChange={handleCSV} className="absolute inset-0 opacity-0 cursor-pointer" /><i data-lucide="upload-cloud" className="mx-auto text-indigo-400 w-8 h-8 mb-2"></i><span className="text-sm font-bold text-indigo-600 block">Upload CSV ke Cloud</span><span className="text-xs text-gray-400">Format: Nama,Kategori,Kelas</span></div><button onClick={() => setShowAddForm(!showAddForm)} className="w-full text-sm font-bold text-indigo-600 hover:bg-indigo-50 py-2 rounded transition">+ Input Manual</button>{showAddForm && (<div className="bg-slate-50 p-4 rounded border animate-bounce-in"><h3 className="font-bold text-xs mb-2 text-gray-500 uppercase">{editingId ? 'Edit Peserta' : 'Tambah Peserta'}</h3><input className="w-full p-2 border rounded mb-2" placeholder="Nama Lengkap" value={formData.nama} onChange={e => setFormData({...formData, nama: e.target.value})} /><select className="w-full p-2 border rounded mb-2" value={formData.kategori} onChange={e => setFormData({...formData, kategori: e.target.value})}><option>Anak Sekolah Minggu</option><option>GSM</option><option>Panitia</option><option>Umum</option><option>Kelas</option> </select><select className="w-full p-2 border rounded mb-2" value={formData.kelas} onChange={e => setFormData({...formData, kelas: e.target.value})}><option value="">-- Pilih Kelas --</option>{classList.map(c => <option key={c} value={c}>{c}</option>)}</select><div className="flex gap-2"><button onClick={handleAddOrUpdateParticipant} className={`flex-1 text-white px-3 py-2 rounded font-bold ${editingId ? 'bg-orange-500' : 'bg-indigo-600'}`}>{editingId ? 'Update' : 'Simpan'}</button>{editingId && <button onClick={() => { setEditingId(null); setFormData({nama:'', kategori:'Anak Sekolah Minggu', kelas: ''}); setShowAddForm(false); }} className="bg-gray-400 text-white px-3 py-2 rounded">Batal</button>}</div></div>)}</div>{participants.length > 0 && <button onClick={downloadAllQR} disabled={isDownloading} className="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold mb-6 flex justify-center gap-2 transition">{isDownloading ? 'Sedang Download...' : <><i data-lucide="download"></i> Download Semua QR</>}</button>}<div className="grid grid-cols-2 gap-3">{participants.map(p => (<div key={p.id} className={`border p-3 rounded text-center bg-white shadow-sm hover:shadow-md transition relative ${editingId === p.id ? 'border-orange-400 bg-orange-50' : ''}`}><div className="absolute top-2 right-2 flex gap-1"><button onClick={() => downloadSingleQR(p)} className="text-emerald-500 bg-emerald-50 p-1 rounded hover:bg-emerald-100"><i data-lucide="download" width="12"></i></button><button onClick={() => startEditParticipant(p)} className="text-blue-500 bg-blue-50 p-1 rounded hover:bg-blue-100"><i data-lucide="pencil" width="12"></i></button><button onClick={() => initiateDelete(`participants/${p.id}`)} className="text-red-500 bg-red-50 p-1 rounded hover:bg-red-100"><i data-lucide="trash-2" width="12"></i></button></div><img src={generateQRUrl(p.id)} className="w-24 mx-auto mb-2 mix-blend-multiply cursor-pointer hover:scale-110 transition-transform duration-200 border-2 border-transparent hover:border-indigo-200 rounded-lg p-1" loading="lazy" onClick={() => downloadSingleQR(p)} title="Klik untuk download QR" /><p className="font-bold text-xs truncate text-slate-800">{p.nama}</p><p className="text-[10px] text-gray-500 bg-gray-100 rounded px-1 inline-block mt-1">{p.kategori}</p>{p.kelas && <p className="text-sm font-black text-red-600 mt-1 uppercase tracking-tighter">{p.kelas}</p>}</div>))}</div></div></div>{deleteConfig.show && <DeleteConfirmModal />}</div>);
            if (view === 'scan') return (<div key="view-scan" className="min-h-screen bg-black flex flex-col"><div className="p-4 bg-gray-900 text-white flex justify-between items-center z-10 shadow-lg"><button onClick={handleBackToMenu} className="flex items-center gap-2 text-gray-300 hover:text-white"><i data-lucide="arrow-left"></i> Menu</button><span className="font-bold tracking-widest text-indigo-400">SCANNER</span><div className="w-16"></div></div><div className="bg-gray-800 p-2 flex justify-center"><select className="bg-gray-700 text-white text-sm p-2 rounded border border-gray-600 max-w-xs" value={selectedSession || ''} onChange={(e) => setSelectedSession(e.target.value)}><option value="" disabled>-- Pilih Sesi Kegiatan --</option>{sessions.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div><div className="flex-1 bg-black relative flex flex-col justify-center items-center"><div className="w-full max-w-sm px-4">{!selectedSession ? (<div className="text-center text-gray-400 p-8 border border-gray-700 rounded-xl"><i data-lucide="alert-triangle" className="mx-auto mb-2 text-yellow-500"></i><p>Mohon Pilih Sesi Kegiatan di atas untuk mulai scan.</p></div>) : ( !scanResult && <div id="reader" className="w-full bg-black rounded-xl overflow-hidden border-2 border-indigo-600 shadow-[0_0_20px_rgba(79,70,229,0.5)]" style={{ display: scanResult ? 'none' : 'block' }}></div> )}</div>{scanResult && (<div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-6 backdrop-blur-sm"><div className="bg-white w-full max-w-sm rounded-2xl p-6 text-center animate-bounce-in shadow-2xl"><div className="flex justify-center mb-4">{scanResult.success ? <i data-lucide="check-circle" className="text-emerald-500 w-20 h-20"></i> : <i data-lucide="x-circle" className="text-red-500 w-20 h-20"></i>}</div><h3 className={`text-2xl font-black mb-2 ${scanResult.success ? 'text-emerald-700' : 'text-red-600'}`}>{scanResult.success ? 'BERHASIL' : 'GAGAL'}</h3><p className="text-gray-600 font-medium mb-4">{scanResult.msg}</p>{scanResult.p && (<div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 shadow-inner"><h4 className="text-xl font-bold text-slate-800">{scanResult.p.nama}</h4><span className="inline-block bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full mt-1 mb-2">{scanResult.p.kategori}</span>{scanResult.p.kelas && <div className="text-sm font-black text-red-600 uppercase mt-2 tracking-tighter">{scanResult.p.kelas}</div>}<p className="text-xs text-slate-400 border-t border-slate-200 pt-2 mt-2">{scanResult.time}</p></div>)}<button onClick={() => { setScanResult(null); }} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">Scan Lagi</button></div></div>)}</div></div>);
            if (view === 'report') return (<div key="view-report" className="min-h-screen bg-orange-50 p-4"><div className="max-w-md mx-auto"><button onClick={handleBackToMenu} className="mb-4 text-slate-600 flex items-center gap-2"><i data-lucide="arrow-left"></i> Kembali</button><div className="bg-white rounded-xl shadow overflow-hidden"><div className="p-4 border-b bg-orange-50"><h2 className="font-bold text-orange-800 flex items-center gap-2 mb-3"><i data-lucide="clipboard-list"></i> Laporan Realtime</h2><div className="flex gap-2 mb-2"><select className="flex-1 text-sm border p-2 rounded bg-white" value={selectedSession || ''} onChange={(e) => setSelectedSession(e.target.value)}><option value="" disabled>-- Pilih Sesi --</option>{sessions.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>{selectedSession && (<button onClick={() => { const sessionName = getSessionName(selectedSession); const csv = ['No,ID,Nama,Kategori,Kelas,Waktu,Petugas', ...attendance.map((a,i) => `${i+1},${a.id},"${a.nama}",${a.kategori},"${a.kelas||'-'}", "${a.timestamp}",${a.device||'-'}`)].join('\n'); const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'})); link.download = `Absensi_${sessionName}.csv`; link.click(); }} className="w-full bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-2 rounded-lg font-bold flex justify-center gap-1 items-center transition shadow-sm"><i data-lucide="download" width="14"></i> EXPORT CSV SESI INI</button>)}</div><div className="overflow-x-auto min-h-[300px]">{!selectedSession ? <p className="text-center text-gray-400 py-10">Pilih sesi untuk melihat data.</p> : attendance.length === 0 ? <p className="text-center text-gray-400 py-10">Belum ada data hadir di sesi ini.</p> : (<table className="w-full text-sm text-left"><thead className="bg-gray-100 text-gray-500 font-medium text-xs uppercase"><tr><th className="p-3">No</th><th className="p-3">Nama</th><th className="p-3">Waktu</th>{!isPeserta && <th className="p-3 text-center">Hapus</th>}</tr></thead><tbody className="divide-y divide-gray-100">{attendance.map((a, i) => (<tr key={i} className="hover:bg-orange-50/50 transition"><td className="p-3 text-gray-400 font-mono">{i+1}</td><td className="p-3"><span className="font-bold text-gray-700 block">{a.nama}</span><span className="text-[10px] text-orange-500 bg-orange-100 px-1 rounded mr-1">{a.kategori}</span>{a.kelas && <span className="text-[10px] text-white bg-red-500 px-1 rounded font-bold">{a.kelas}</span>}</td><td className="p-3 text-xs text-gray-500">{a.timestamp} <br/><span className="text-[9px] text-gray-400">by {a.device}</span></td>{!isPeserta && (<td className="p-3 text-center"><button onClick={() => initiateDelete(`attendance/${selectedSession}/${a.id}`)} className="text-rose-500 bg-rose-50 p-2 rounded-lg hover:bg-rose-100 transition shadow-sm border border-rose-100" title="Hapus"><i data-lucide="trash-2" width="14"></i></button></td>)}</tr>))}</tbody></table>)}</div></div></div>{deleteConfig.show && <DeleteConfirmModal />}</div>);

            // --- JARING PENGAMAN (SAFETY NET) ---
            return (
                <div className="min-h-screen flex items-center justify-center bg-school-sunday text-center p-4">
                    <div className="bg-white/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl">
                        <div className="animate-spin w-10 h-10 border-4 border-orange-400 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <h1 className="text-xl font-black text-slate-700 mb-1">Memuat...</h1>
                        <button onClick={() => window.location.reload()} className="text-indigo-500 font-bold text-sm underline">Refresh Halaman</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CloudAttendance />);
    </script>
</body>
</html>
